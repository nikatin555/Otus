
# –ü—Ä–æ–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞
# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL 17 –Ω–∞ –±–∞–∑–µ Patroni –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å Microsoft SQL Server 2007/2019

–ó–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å  –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä Patroni —Å PostgreSQL 17 –Ω–∞ AlmaLinux 10 (4 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã. AlmaLinux 10 —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å firewall, –∑–∞—â–∏—Ç—ã –æ—Ç –≤–∑–ª–æ–º–∞,ddos, bruetforce –∏ —Ç.–¥.,).;
–ù–∞ PostgreSQL 17 –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –æ—Ç 1–°. 
–ù–∞ PostgreSQL 17 –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—ã 1–° —Å MS SQL 2019 (1–° –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, 1–° –ë–ü) –∏ MS SQL 2007 (1–° –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ).

–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL 17 –Ω–∞ –±–∞–∑–µ Patroni –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å Microsoft SQL Server 2007/2019

**–ì–ª–∞–≤–∞ 1: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**
*   –í–≤–µ–¥–µ–Ω–∏–µ: –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ 1–° —Å –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã—Ö –°–£–ë–î –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è. –ü—Ä–æ–±–ª–µ–º—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π (MS SQL 2007).
*   –û–±–∑–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ PostgreSQL 17 –∏ MS SQL Server. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏.
*   –û–±–∑–æ—Ä —Ä–µ—à–µ–Ω–∏–π –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏: –ü–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω Patroni+ETCD (–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π PostgreSQL).
*   –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ü–û, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.

**–ì–ª–∞–≤–∞ 2: –ü—Ä–æ–µ–∫—Ç–Ω–∞—è —á–∞—Å—Ç—å**
*   –ü—Ä–æ–µ–∫—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –°—Ö–µ–º–∞ —Å–µ—Ç–∏.
*   –í—ã–±–æ—Ä –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞—â–∏—Ç—ã: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `firewalld`, `fail2ban` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç bruteforce, –±–∞–∑–æ–≤—ã–µ –º–µ—Ä—ã hardening –¥–ª—è AlmaLinux 10 (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Å–ª—É–∂–±, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–∞—Ä–æ–ª–µ–π, `ssh` —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á—É).
*   –ü—Ä–æ–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º 1–° (``shared_buffers``, ``work_mem``, ``effective_cache_size``, ``max_connections`` –∏ —Ç.–¥.).
*   –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏: –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pgloader`, ora2pg –∏–ª–∏ —à—Ç–∞—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ 1–° - —è –≤—ã–±—Ä–∞–ª —ç—Ç–æ—Ç –º–µ—Ç–æ–¥, –ø—Ä–æ—Å—Ç–æ—Ç–∞ ,–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ —Ç.–¥.). –≠—Ç–∞–ø—ã –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏.

**–ì–ª–∞–≤–∞ 3: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**
*   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ AlmaLinux 10 –Ω–∞ –≤—Å–µ—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö.
*   –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ firewall –∏ –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.
*   –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL 17.
*   –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Patroni, DCS (etcd), –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.
*   –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö: –ü–æ—à–∞–≥–æ–≤–æ–µ –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ 1–°: –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –ó–£–ü 
*   –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
    *   **–¢–µ—Å—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏:** –†—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–∞ (`patronictl switchover`), —Å–∏–º—É–ª—è—Ü–∏—è —Å–±–æ—è –Ω–æ–¥—ã.
   

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**
*   –ò—Ç–æ–≥–∏ —Ä–∞–±–æ—Ç—ã: –ß—Ç–æ –±—ã–ª–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ.
*   –í—ã–≤–æ–¥—ã: –° –∫–∞–∫–∏–º–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—è–º–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å, –∫–∞–∫ –∏—Ö —Ä–µ—à–∏–ª–∏.
*   –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ): –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç –Ω–∞ MSSQL.
*   –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è: –í–æ–∑–º–æ–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ PGBackRest, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Prometheus/Grafana), –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π —Å—Ö–µ–º—ã –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (HAProxy).

-----------------------------------------------------------------------------

# **–ì–ª–∞–≤–∞ 1: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å**

## **1.1. –í–≤–µ–¥–µ–Ω–∏–µ: –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ 1–° —Å –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã—Ö –°–£–ë–î –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è**

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–∏–∑–Ω–µ—Å-—Å—Ä–µ–¥–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ¬´1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ¬ª, —è–≤–ª—è—é—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —Å–ª–æ–∂–∏–ª–æ—Å—å, —á—Ç–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–∏—Ö —Å–∏—Å—Ç–µ–º —á–∞—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –≤ —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, Microsoft SQL Server. –û–¥–Ω–∞–∫–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤–∞—è —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–∏—Å—Ç–µ–º—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ PostgreSQL.

**–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –æ–±—É—Å–ª–æ–≤–ª–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏:**

1.  **–°–Ω–∏–∂–µ–Ω–∏–µ —Å–æ–≤–æ–∫—É–ø–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–ª–∞–¥–µ–Ω–∏—è (TCO):** –õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–∞ Microsoft SQL Server, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —è–¥–µ—Ä, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã. PostgreSQL —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ PostgreSQL License, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–µ –ü–û.
2.  **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏ —Å—É–≤–µ—Ä–µ–Ω–∏—Ç–µ—Ç:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ü–û —Å–Ω–∏–∂–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–µ–Ω–¥–æ—Ä–∞ –∏ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤, —á—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –≤ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö. –ö–æ–º–ø–∞–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–≤–æ–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–∞–Ω–Ω—ã—Ö.
3.  **–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π –°–£–ë–î, —Ç–∞–∫–∏—Ö –∫–∞–∫ **Microsoft SQL Server 2007**, —Å–æ–ø—Ä—è–∂–µ–Ω–æ —Å —Å–µ—Ä—å–µ–∑–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏:
    *   **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–µ –∫–∏–±–µ—Ä—Ä–∏—Å–∫–∏.
    *   **–ù–∏–∑–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–±—ä–µ–º–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
    *   **–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ MS SQL –º–æ–≥—É—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –Ω–æ–≤—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ –û–° –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–°, –±–ª–æ–∫–∏—Ä—É—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ.
4.  **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è 1–°:** –ù–∞—á–∏–Ω–∞—è —Å –≤–µ—Ä—Å–∏–π 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 8.3, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —É–¥–µ–ª—è—é—Ç –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–∞–±–æ—Ç—ã —Å PostgreSQL. –í –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö 1–° —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É PostgreSQL.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–∏–≥—Ä–∞—Ü–∏—è —Å MS SQL Server 2007/2019 –Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL 17 —è–≤–ª—è–µ—Ç—Å—è –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, –∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π –º–µ—Ä–æ–π, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ò–¢-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

## **1.2. –û–±–∑–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ PostgreSQL 17 –∏ MS SQL Server**

–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ–¥–µ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–≤—É—Ö —Å–∏—Å—Ç–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Microsoft SQL Server | PostgreSQL 17 | –í—ã–≤–æ–¥—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ 1–° |
| :--- | :--- | :--- | :--- |
| **–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å** | –ü—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è. –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–π (–Ω–∞ —è–¥—Ä–∞/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π). –¢—Ä–µ–±—É—é—Ç—Å—è –ª–∏—Ü–µ–Ω–∑–∏–∏ –¥–ª—è –ø–∞—Å—Å–∏–≤–Ω—ã—Ö —Ä–µ–ø–ª–∏–∫ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ. | –û—Ç–∫—Ä—ã—Ç–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è (PostgreSQL License). –ë–µ—Å–ø–ª–∞—Ç–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ. | **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ PostgreSQL.** –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã—Ö –∏–∑–¥–µ—Ä–∂–µ–∫. |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ OLTP-–Ω–∞–≥—Ä—É–∑–∫–∞—Ö. –•–æ—Ä–æ—à–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –û–° Windows. | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ (14-17) –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ä–∞–≤–Ω–∏–º—É—é –∏–ª–∏ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—è—â—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Ç–µ—Å—Ç–∞—Ö, –±–ª–∏–∑–∫–∏—Ö –∫ –Ω–∞–≥—Ä—É–∑–∫–µ 1–°. –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º. | **–ü–∞—Ä–∏—Ç–µ—Ç —Å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º –¥–ª—è PostgreSQL 17.** –î–ª—è —Ç–∏–ø–∏—á–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ 1–° (—Å–º–µ—Å—å OLTP –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏) PostgreSQL 17 –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** | –í—ã—Å–æ–∫–∞—è. –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è WAL (Write-Ahead Logging). | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è. –¢–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ WAL-–∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (MVCC) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö. | **–ü–∞—Ä–∏—Ç–µ—Ç.** –û–±–µ –°–£–ë–î –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏. |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | –ë–æ–≥–∞—Ç—ã–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: TDE, Row-Level Security, Dynamic Data Masking. | –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–∫–µ, SSL-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π (FDW), SEPostgreSQL (–Ω–∞ –æ—Å–Ω–æ–≤–µ SELinux). –†–∞–∑–≤–∏—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π. | **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ MS SQL Server** –≤ —á–∞—Å—Ç–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö enterprise-—Ñ—É–Ω–∫—Ü–∏–π. –û–¥–Ω–∞–∫–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π 1–° —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ PostgreSQL –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ) —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –†–µ–ø–ª–∏–∫–∞—Ü–∏—è Read-Scale Availability Groups. | –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —á—Ç–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ—â–µ. –ê–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–µ–∫—Ç—ã —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è (Citus, Postgres-XL). –õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –æ—á–µ–Ω—å –≥–∏–±–∫–∞—è. | **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ PostgreSQL** –¥–ª—è —Ä–µ—à–µ–Ω–∏–π —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ —á—Ç–µ–Ω–∏–µ. –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–µ –∏ –º–µ–Ω–µ–µ –∑–∞—Ç—Ä–∞—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è. |
| **–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ** | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏–µ–π Microsoft. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è. | –û–≥—Ä–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, —Ç—ã—Å—è—á–∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pg_partman` –¥–ª—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, `pg_stat_statements` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞). | **–ü–∞—Ä–∏—Ç–µ—Ç.** MS SQL –∏–º–µ–µ—Ç —Å–∏–ª—å–Ω—É—é –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É, –∞ PostgreSQL ‚Äî –≥–∏–±–∫–æ—Å—Ç—å –∏ –±–æ–≥–∞—Ç—É—é —ç–∫–æ—Å–∏—Å—Ç–µ–º—É. |

**–ò—Ç–æ–≥:** –î–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ PostgreSQL 17 –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≥–∏–±–∫–æ—Å—Ç–∏, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

## **1.3. –û–±–∑–æ—Ä —Ä–µ—à–µ–Ω–∏–π –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏: –í—ã–±–æ—Ä Patroni + etcd**

–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –¥–ª—è —Å–∏—Å—Ç–µ–º 1–°. –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è "–º–∞—Å—Ç–µ—Ä-—Ä–µ–ø–ª–∏–∫–∞" –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø—Ä–∏ —Å–±–æ–µ –º–∞—Å—Ç–µ—Ä–∞. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ High Availability (HA) –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL.

*   **–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è PostgreSQL:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ WAL, –Ω–æ –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –º–µ—Ö–∞–Ω–∏–∑–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (failover). –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —á—Ç–æ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.
*   **Pgpool-II:** –ü—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—É–ª–∏–Ω–≥–æ–≤ –∏ –º–µ—Ö–∞–Ω–∏–∑–º failover. –û–¥–Ω–∞–∫–æ –µ–≥–æ –ª–æ–≥–∏–∫–∞ failover –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–æ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ, –∞ —Å–∞–º –æ–Ω –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–æ–π –æ—Ç–∫–∞–∑–∞, —Ç—Ä–µ–±—É—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏.
*   **–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫—Ä–∏–ø—Ç–æ–≤:** –í—ã—Å–æ–∫–∞—è –≥–∏–±–∫–æ—Å—Ç—å, –Ω–æ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫. –ù–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º.
*   **Patroni:** –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è. –û–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏, –∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –¥–µ–º–æ–Ω –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ –∫–ª–∞—Å—Ç–µ—Ä–∞.

**–ü–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω Patroni –≤ —Å–≤—è–∑–∫–µ —Å etcd?**

1.  **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞:** Patroni –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Distributed Key-Value Store), —Ç–∞–∫–æ–µ –∫–∞–∫ **etcd**, –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –≤—ã–±–æ—Ä–∞ –ª–∏–¥–µ—Ä–∞. –°–∞–º etcd —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –≤–∏–¥–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–æ–±—ã—á–Ω–æ 3 –∏–ª–∏ 5 —É–∑–ª–æ–≤), —á—Ç–æ –¥–µ–ª–∞–µ—Ç –≤—Å—é —Å–∏—Å—Ç–µ–º—É —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ —Å–±–æ—è–º.
2.  **–ù–∞–¥–µ–∂–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã–±–æ—Ä–∞ –ª–∏–¥–µ—Ä–∞ (Leader Election):** etcd –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–µ–º –∫–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (Raft), –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –º–∞—Å—Ç–µ—Ä.
3.  **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π Failover/Switchover:** Patroni –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å–±–æ–π –º–∞—Å—Ç–µ—Ä–∞ –∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –Ω–æ–≤—É—é —Ä–µ–ø–ª–∏–∫—É-–ª–∏–¥–µ—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–µ–∫—É–Ω–¥. –¢–∞–∫–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–ª–∞–Ω–æ–≤—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (switchover) –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.
4.  **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** Patroni –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π REST API –∏ –∫–æ–º–∞–Ω–¥—ã CLI –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏.
5.  **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —É—Ç–∏–ª–∏—Ç–æ–π `pg_basebackup`:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–ø–ª–∏–∫.

**–í—ã–≤–æ–¥:** –°–≤—è–∑–∫–∞ **Patroni + etcd** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –Ω–∞–∏–±–æ–ª–µ–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é, –Ω–∞–¥–µ–∂–Ω—É—é –∏ –ª–µ–≥–∫–æ —É–ø—Ä–∞–≤–ª—è–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è HA-–∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL, —á—Ç–æ –∏–¥–µ–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–ª—è 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ.

## **1.4. –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π**

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏—Å—Ö–æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É—é —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –Ω–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –±–∞–∑—ã 1—Å –∑–∞—Ä–ø–ª–∞—Ç–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ).

**–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

*   **–°–µ—Ä–≤–µ—Ä—ã –ë–î (–Ω–µ –º–µ–Ω–µ–µ 3 —É–∑–ª–æ–≤):**
    *   **CPU:** –ú–Ω–æ–≥–æ—è–¥–µ—Ä–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 4-6 —è–¥–µ—Ä –Ω–∞ —É–∑–µ–ª). 1–° —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ —á–∞—Å—Ç–æ—Ç–µ CPU, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∞—è —Ç–∞–∫—Ç–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞.
    *   **RAM:** –ù–µ –º–µ–Ω–µ–µ 16 –ì–ë –û–ó–£. –†–∞–∑–º–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–∑–≤–æ–ª—è—Ç—å —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç–∏ "—Ä–∞–±–æ—á–∏–π –Ω–∞–±–æ—Ä" –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–µ–∫—Å–æ–≤.
    *   **–î–∏—Å–∫–æ–≤–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞:** –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ SSD (NVMe –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ). RAID 1 –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, WAL-–ª–æ–≥–æ–ª–æ–≤ –∏ –∂—É—Ä–Ω–∞–ª–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
    *   **–°–µ—Ç—å:** –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (–Ω–µ –º–µ–Ω–µ–µ 1 GbE) –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni/etcd.
*   **–°–µ—Ä–≤–µ—Ä—ã etcd (3 —É–∑–ª–∞):**
    *   –ú–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –Ω–∞ –º–µ–Ω–µ–µ –º–æ—â–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö (2 —è–¥—Ä–∞, 3-4 –ì–ë –û–ó–£, SSD-–¥–∏—Å–∫–∏).
    *   –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å–µ—Ç–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–º—É –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é:**

*   **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:**  AlmaLinux 10 (–∫–∞–∫ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π, —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤).
*   **–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQLPro 17 Standard (–≥–æ—Ç–æ–≤–æ–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ 1–°).
*   **–ü–û –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏:** Patroni (–ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏), etcd.
*   **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ 1–°:** –°–µ—Ä–≤–µ—Ä 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 8.3.21 –∏ –≤—ã—à–µ (—Å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π PostgreSQL).

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**

*   **–ò–∑–æ–ª—è—Ü–∏—è:** –°–µ—Ä–≤–µ—Ä—ã –ë–î –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ —Å–µ—Ç–∏ (DMZ).
*   **–î–æ—Å—Ç—É–ø:** –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π SSH –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π.
*   **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SSL/TLS –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (—Å–µ—Ä–≤–µ—Ä–∞–º–∏ 1–°) –∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–º –ë–î, –∞ —Ç–∞–∫–∂–µ –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.
*   **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–≥—É–ª—è—Ä–Ω–æ–µ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ) –ø–æ–ª–Ω–æ–µ –∏ WAL-—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é —É—Ç–∏–ª–∏—Ç—ã `pg_backrest` –∏–ª–∏ `barman`. –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–π –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–µ—Å—É—Ä—Å–µ.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**

*   **–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:** –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã (Availability) ‚Äî 99.9% –∏ –≤—ã—à–µ.
*   **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (RTO):** –ù–µ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–±–æ–µ –º–∞—Å—Ç–µ—Ä–∞.
*   **–¶–µ–ª–µ–≤–∞—è —Ç–æ—á–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (RPO):** ~0 —Å–µ–∫—É–Ω–¥ (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –∫–∞–∫ –º–∏–Ω–∏–º—É–º –Ω–∞ –æ–¥–Ω—É —Ä–µ–ø–ª–∏–∫—É).
*   **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ö–ª–∞—Å—Ç–µ—Ä –∏–∑ 3 —É–∑–ª–æ–≤ PostgreSQL + –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ 3 —É–∑–ª–æ–≤ etcd. –û–¥–∏–Ω —É–∑–µ–ª PostgreSQL ‚Äî –º–∞—Å—Ç–µ—Ä, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏. –°–µ—Ä–≤–µ—Ä—ã 1–° –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ –º–∞—Å—Ç–µ—Ä-—É–∑–ª—É —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ (HAProxy).
*   **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ (Patroni, PostgreSQL, etcd, –û–°) —Å –ø–æ–º–æ—â—å—é Zabbix/Prometheus + Grafana –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü.

## **1.5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏**

–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç—å –∏ —Ç–µ—Ö–Ω–∏–∫–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –±–∞–∑–µ Microsoft SQL Server 2007/2019 –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL 17, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Patroni. –í—ã–±—Ä–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ—Å—Ç–∏—á—å —Ç—Ä–µ–±—É–µ–º—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–º —Å–Ω–∏–∂–µ–Ω–∏–∏ —Å–æ–≤–æ–∫—É–ø–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–ª–∞–¥–µ–Ω–∏—è, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ.

# **–ì–ª–∞–≤–∞ 2. –ü—Ä–æ–µ–∫—Ç–Ω–∞—è —á–∞—Å—Ç—å**


## **2.1. –ü—Ä–æ–µ–∫—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

###  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni + etcd –¥–ª—è PostgreSQLPro 17

#### üñ•Ô∏è –°–µ—Ä–≤–µ—Ä–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

#### **–ö–ª–∞—Å—Ç–µ—Ä PostgreSQL —Å Patroni**

| –°–µ—Ä–≤–µ—Ä | IP-–∞–¥—Ä–µ—Å | –†–æ–ª—å | –û–° | –û–ó–£ | vCPU | –î–∏—Å–∫ SSD –û–° | –î–∏—Å–∫ SSD –ë–î | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ |
|--------|----------|------|----|-----|------|---------|---------|-----------|
| **spbpsql1** | `192.168.10.204` | üéØ –ú–∞—Å—Ç–µ—Ä/–†–µ–ø–ª–∏–∫–∞ | AlmaLinux 10 | 16 –ì–ë | 6 | 50 –ì–ë | 50 –ì–ë | **Hyper-V** |
| **spbpsql2** | `192.168.10.207` | üìã –†–µ–ø–ª–∏–∫–∞ | AlmaLinux 10 | 16 –ì–ë | 6 | 50 –ì–ë | 50 –ì–ë | **Hyper-V** |

#### **–ö–ª–∞—Å—Ç–µ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ etcd**

| –°–µ—Ä–≤–µ—Ä | IP-–∞–¥—Ä–µ—Å | –†–æ–ª—å | –û–° | –û–ó–£ | vCPU | –î–∏—Å–∫ SSD –û–° | –î–∏—Å–∫ SSD –ë–î | –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ |
|--------|----------|------|----|-----|------|---------|---------|-----------|
| **spbetcd1** | `192.168.10.209` | üóÇÔ∏è –£–∑–µ–ª etcd | AlmaLinux 10 | 3 –ì–ë | 2 | 50 –ì–ë | ‚Äî | **Hyper-V** |
| **spbetcd2** | `192.168.10.211` | üóÇÔ∏è –£–∑–µ–ª etcd | AlmaLinux 10 | 3 –ì–ë | 2 | 50 –ì–ë | ‚Äî | **Hyper-V** |
| **spbetcd3** | `192.168.10.181` | üóÇÔ∏è –£–∑–µ–ª etcd | AlmaLinux 10 | 3 –ì–ë | 2 | 50 –ì–ë | ‚Äî | **Hyper-V** |


 **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**
- ‚úÖ **–ö–≤–æ—Ä—É–º etcd** - –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑ 1 –∏–∑ 3 —É–∑–ª–æ–≤
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–µ–π–ª–æ–≤–µ—Ä** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ–µ –º–∞—Å—Ç–µ—Ä–∞
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** - –≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

 **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- üöÄ **PostgreSQLPro 17** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
- üîÑ **Streaming —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- ‚ö° **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Å–µ–Ω—Å—É—Å** - –±—ã—Å—Ç—Ä—ã–µ –≤—ã–±–æ—Ä—ã –ª–∏–¥–µ—Ä–∞

 **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- üîí **TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Ç–∏
- üõ°Ô∏è **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
- üìù **–ê—É–¥–∏—Ç** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π

**üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**

| –§—É–Ω–∫—Ü–∏—è | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ |
|---------|--------------|
| **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–µ–π–ª–æ–≤–µ—Ä** | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è |
| **–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã** | –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ RAM/CPU |
| **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** | –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è** | –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º |
| **–ë—ç–∫–∞–ø—ã —Å —Ä–µ–ø–ª–∏–∫** | –ë–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –º–∞—Å—Ç–µ—Ä |

**üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫**

- **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: Hyper-V –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (3–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞)
- **–û–°**: Almalinux 10
- **–ë–î**: PostgreSQLPro 17
- **–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è**: Patroni
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: etcd
- **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è**: –ù–∞—Ç–∏–≤–Ω—ã–π streaming replication

*–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ Hyper-V*.

–Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã etcd –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å 2–º—è –¥–∏—Å–∫–∞–º (–¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –û–° –∏ –¥–∞–Ω–Ω—ã—Ö), PodthreSQLPro+Patroni  –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 3—Ö VM (—Å —Ç–∞–∫–∏–º –∂–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –û–° –∏ DB). –í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Ç–∞–∫–∂–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ IP (–Ω–∞–ø—Ä–∏–º–µ—Ä keepalived) –∏–ª–∏ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø—É–ª–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π PgBouncer, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞ (HAProxy) –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤. –¢.–∫. —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞ –∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω –ø—É—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —è –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ 2—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ 1–° (–¥–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–∞–∑—ã –≤ 1–°: –æ—Å–Ω–æ–≤–Ω–∞—è spbpsql1:5432 –∏ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è spbpsql2:5432, –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –æ—Å–Ω–æ–≤–Ω–æ–π –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é).

**–ü—Ä–æ–±–ª–µ–º—ã**:–ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ VM —Å Almalinux 10 –Ω–∞ Hyper-V WS 2012 St –∏ Ptoxmox VE 8 - —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä. –ü.—ç. –ø—Ä–∏–Ω—è—Ç–æ –±—ã–ª–æ —Ä–µ—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ VM –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö Hyper-V —Å WS 2019-2022 St. 


#### üîÑ –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

![alt text](image-32.png)

**2.2. –í—ã–±–æ—Ä –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞—â–∏—Ç—ã**

*   **–ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `firewalld`** - –û—Ç–∫—Ä—ã—Ç–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ—Ä—Ç–æ–≤: 5432 (PostgreSQL), 8008 (Patroni API), 2379-2380 (etcd), 22 (SSH). –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–æ–≤ –ë–î –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ç–µ–≤–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ.
*   **–ë–∞–∑–æ–≤—ã–µ –º–µ—Ä—ã hardening –¥–ª—è AlmaLinux 10** - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Å–ª—É–∂–±, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–∞—Ä–æ–ª–µ–π (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ 8 —Å–∏–º–≤–æ–ª–æ–≤, —Å–ª–æ–∂–Ω–æ—Å—Ç—å), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SSH-–∫–ª—é—á–µ–π –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ root-–ª–æ–≥–∏–Ω–∞ –ø–æ SSH.
*   **–ü–ª–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SELinux** - –ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ permissive –≤ enforcing —Ä–µ–∂–∏–º: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è Patroni –∏ PostgreSQL, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—É—Ç–µ–π, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.

**2.3. –ü—Ä–æ–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL –∏ Patroni**

*   **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã PostgreSQL –¥–ª—è 1–°** - `shared_buffers=4GB` (25% –û–ó–£), `work_mem=64MB` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ `maintenance_work_mem=2GB` –¥–ª—è VACUUM, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–≤–∞–∫—É—É–º (`scale_factor=0.1`), —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã (`lock_timeout=10s`, `statement_timeout=3600s`) –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π 1–°.
*   **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ `patroni.yml`** - –í–∫–ª—é—á–∞–µ—Ç —Å–µ–∫—Ü–∏–∏: `bootstrap` (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞), `postgresql` (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î), `restapi` (API Patroni), `etcd3` (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ DCS), `tags` (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º –Ω–æ–¥). –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ etcd.
*   **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ª–æ—Ç–æ–≤, –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (`replicator`) –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (`admindbps`), –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ pg_hba –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Ç–æ–ª—å–∫–æ –∏–∑ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø–æ–¥—Å–µ—Ç–µ–π, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è `ru_RU.UTF-8` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ 1–°.

**2.4. –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö**

*   **–í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ (.dt)** - –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: —à—Ç–∞—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º 1–°, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã (pgloader, AWS DMS (Database Migration Service), Azure Data Factory) –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã –∏–∑-–∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å MS SQL Server.
*   **–≠—Ç–∞–ø—ã –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö** - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π 1–°, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ODBC-–¥—Ä–∞–π–≤–µ—Ä–æ–≤), –≤—ã–≥—Ä—É–∑–∫–∞ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä 1–° ‚Üí .dt —Ñ–∞–π–ª), –∑–∞–≥—Ä—É–∑–∫–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–π –ë–î –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ .dt), —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π).
*   **–ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤, —Ç–µ—Å—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–≤–æ–¥–∞-–ø—Ä–æ–≤–æ–¥–æ–∫, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ó–£–ü (—Ä–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤), –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Å–∏—Å—Ç–µ–º (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∏–Ω–¥–µ–∫—Å—ã). –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.

## **–ì–ª–∞–≤–∞ 3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**

### **3.1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**

#### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ AlmaLinux 10
–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ AlmaLinux 10 (—Å–µ—Ç—å, hostname –±—ã–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤–æ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏) –≤—ã–ø–æ–ª–Ω–∏–ª —ç—Ç–∏ —à–∞–≥–∏ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö:

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
```bash
sudo dnf update -y
sudo dnf install -y epel-release
sudo dnf install -y curl wget git tar policycoreutils-python-utils fail2ban fail2ban-firewalld policycoreutils-python-utils setroubleshoot-server setools-console curl net-tools chrony sshpass

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–≤ –º–æ—ë–º —Å–ª—É—á–∞–µ, —è –Ω–∞—Å—Ç—Ä–æ–∏–ª NTP-—Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –û–°)
sudo systemctl enable --now chronyd
sudo chronyc sources

#–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å firewall
sudo firewall-cmd --permanent --add-service=postgresql
sudo firewall-cmd --permanent --add-port=2379-2380/tcp # –î–ª—è etcd
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-port=5432/tcp
sudo firewall-cmd --permanent --add-port=8008/tcp # –î–ª—è Patroni API
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS
–ù–∞ DNS-—Å–µ—Ä–≤–µ—Ä–µ –¥–æ–±–∞–≤–ª–∏–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ê –∑–∞–ø–∏—Å–∏ –≤ –ø—Ä—è–º—É—é –∏ –æ–±—Ä–∞—Ç–Ω—É—é –∑–æ–Ω—É,—Ç–∞–∫–∂–µ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ hosts (–Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö):
```bash
sudo tee -a /etc/hosts << EOF
192.168.10.204 spbpsql1
192.168.10.207 spbpsql2
192.168.10.209 spbetcd1
192.168.10.211 spbetcd2
192.168.10.181 spbetcd3
EOF
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SELinux
–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤—ë–ª SELinux –≤ —Ä–µ–∂–∏–º `permissive`:
```bash
sudo setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config
```
 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SELinux –¥–ª—è Patroni –∏ PostgreSQL –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî —ç—Ç–æ –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –Ø –µ–≥–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —É—Å–ø–µ—à–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ü–µ–ª–µ–≤–æ–π —Ä–µ–∂–∏–º (targeted)** —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.

##### –®–∞–≥ 1: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è SELinux

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
sestatus

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
getenforce

# –ï—Å–ª–∏ SELinux –æ—Ç–∫–ª—é—á–µ–Ω, –≤–∫–ª—é—á–∏—Ç—å –µ–≥–æ (—Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
sudo sed -i 's/^SELINUX=.*/SELINUX=enforcing/g' /etc/selinux/config
echo "SELinux –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏"
```

##### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–∏–ª–∏—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SELinux

```bash
sudo dnf install -y policycoreutils-python-utils setroubleshoot-server setools-console
```

##### –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±—É–µ–º—ã—Ö –¥–æ—Å—Ç—É–ø–æ–≤

1. **–ü–µ—Ä–µ–≤–µ–¥—ë–º SELinux –≤ permissive —Ä–µ–∂–∏–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
```bash
sudo setenforce Permissive
```

2. **–ó–∞–ø—É—Å—Ç–∏–º Patroni –∏ –ø–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º**, –≤—ã–ø–æ–ª–Ω—è—è —Ç–∏–ø–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
```bash
sudo systemctl start patroni
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è, —Å–æ–∑–¥–∞–¥–∏–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç.–¥.
```

3. **–ü—Ä–æ—Å–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ SELinux –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π:**
```bash
# –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥
sudo grep sealert /var/log/messages
# –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É sealert
sudo sealert -a /var/log/audit/audit.log

# –ë–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø–æ–∏—Å–∫
sudo ausearch -m avc -ts recent
```

##### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–æ–≥–æ–≤

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞—ë–º –º–æ–¥—É–ª—å SELinux:

```bash
# –°–æ–∑–¥–∞–µ–º –º–æ–¥—É–ª—å –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö AVC-–∑–∞–ø–∏—Å–µ–π
sudo grep avc /var/log/audit/audit.log | audit2allow -m mypatroni > mypatroni.te

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥—É–ª—å
sudo checkmodule -M -m -o mypatroni.mod mypatroni.te
sudo semodule_package -o mypatroni.pp -m mypatroni.mod
sudo semodule -i mypatroni.pp
```

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–æ–≤ –¥–ª—è Patroni API

Patroni –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 8008 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω –≤ SELinux:

```bash
# –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ—Ä—Ç –¥–ª—è Patroni API
sudo semanage port -a -t http_port_t -p tcp 8008
sudo semanage port -a -t postgresql_port_t -p tcp 5432

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã
sudo semanage port -l | grep http_port_t
sudo semanage port -l | grep postgresql_port_t
```

##### –®–∞–≥ 6: –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

PostgreSQL –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Patroni —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏:

```bash
# –†–∞–∑—Ä–µ—à–∏—Ç—å PostgreSQL –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
sudo setsebool -P postgresql_can_network_stream 1
sudo setsebool -P postgresql_can_network_connect 1

# –†–∞–∑—Ä–µ—à–∏—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
sudo setsebool -P postgresql_can_network_connect_db 1
```

##### –®–∞–≥ 7: –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `configure_selinux.sh`:

```bash
#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "Please run as root"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç
dnf install -y policycoreutils-python-utils setroubleshoot-server

# –í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ permissive —Ä–µ–∂–∏–º
setenforce Permissive

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
sudo semanage fcontext -a -t postgresql_db_t "/var/lib/pgpro/1c-17/data(/.*)?"
sudo restorecon -R -v /var/lib/pgpro/1c-17/data/

# –î–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
sudo semanage fcontext -a -t postgresql_db_t "/var/lib/pgpro/1c-17(/.*)?"
sudo restorecon -R -v /var/lib/pgpro/1c-17/

# –î–ª—è –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ PostgreSQL
sudo semanage fcontext -a -t postgresql_exec_t "/opt/pgpro/1c-17/bin/postgres"
sudo semanage fcontext -a -t postgresql_exec_t "/opt/pgpro/1c-17/bin/initdb"
sudo semanage fcontext -a -t postgresql_exec_t "/opt/pgpro/1c-17/bin/pg_ctl"

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
sudo restorecon -R -v /opt/pgpro/1c-17/bin/

# –î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –ª–æ–≥–æ–≤
sudo semanage fcontext -a -t postgresql_log_t "/var/log/postgresql(/.*)?"
sudo restorecon -R -v /var/log/postgresql/

# –ò–ª–∏ –µ—Å–ª–∏ –ª–æ–≥–∏ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
sudo semanage fcontext -a -t postgresql_log_t "/var/lib/pgpro/1c-17/data/pg_log(/.*)?"
sudo restorecon -R -v /var/lib/pgpro/1c-17/data/pg_log/

# –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤
sudo semanage port -a -t http_port_t -p tcp 8008
sudo semanage port -a -t postgresql_port_t -p tcp 5432

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ boolean –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
setsebool -P postgresql_can_network_stream 1
setsebool -P postgresql_can_network_connect 1
setsebool -P postgresql_can_network_connect_db 1

# –†–∞–∑—Ä–µ—à–∏—Ç–µ PostgreSQL —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö
sudo setsebool -P postgresql_connect_any on
sudo setsebool -P postgresql_can_rsync on
sudo setsebool -P daemons_enable_cluster_mode on

# –î–ª—è —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
sudo setsebool -P postgresql_use_tcp_stream on

# –í–∫–ª—é—á–µ–Ω–∏–µ enforcing —Ä–µ–∂–∏–º–∞
setenforce Enforcing

echo "SELinux configuration completed"
echo "Monitor logs with: sealert -a /var/log/audit/audit.log"
```

##### –®–∞–≥ 8: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

**–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
# –†–µ–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π
sudo tail -f /var/log/audit/audit.log | grep avc

# –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é sealert
sudo sealert -a /var/log/audit/audit.log

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö boolean –Ω–∞—Å—Ç—Ä–æ–µ–∫
getsebool -a | grep postgresql
```

**–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏!)
setenforce Permissive

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤
ls -Z /data/patroni/
ls -Z /var/lib/pgsql/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ps auxZ | grep postgres
ps auxZ | grep patroni
```

##### –®–∞–≥ 9: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–±–æ—Ä –ª–æ–≥–æ–≤ SELinux:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ auditd –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
sudo dnf install -y auditd
sudo systemctl enable --now auditd

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª audit –¥–ª—è Patroni
sudo cat > /etc/audit/rules.d/patroni.rules << EOF
-w /data/patroni -p wa -k patroni
-w /etc/patroni.yml -p wa -k patroni
-w /var/log/patroni -p wa -k patroni
EOF

sudo service auditd restart
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

1. **–¢–µ—Å—Ç–∏—Ä—É–µ–º –≤ staging-—Å—Ä–µ–¥–µ** –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
2. **–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è SELinux-–Ω–∞—Ä—É—à–µ–Ω–∏–π
3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –≤—Å–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏**
4. **–û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
5. **–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö `.te` —Ñ–∞–π–ª–æ–≤

–≠—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–µ—Å–ø–µ—á–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ä–∞–±–æ—Ç—É Patroni –∏ PostgreSQL –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º SELinux –≤ —Ä–µ–∂–∏–º–µ enforcing, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞.

### **3.2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ etcd**

#### –ù–∞ –≤—Å–µ—Ö etcd —É–∑–ª–∞—Ö (spbetcd1, spbetcd2, spbetcd3)

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥—Ä—É–ø–ø
sudo groupadd -g 1000 petcdadms
sudo useradd -u 1000 -g petcdadms -s /bin/bash -d /var/lib/etcd -m petcdadms

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ etcd
cd /tmp
ETCD_VERSION="3.6.5"
wget https://github.com/etcd-io/etcd/releases/download/v${ETCD_VERSION}/etcd-v${ETCD_VERSION}-linux-amd64.tar.gz

# –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
echo "–†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤..."
tar xvf etcd-v${ETCD_VERSION}-linux-amd64.tar.gz

# –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
cd etcd-v${ETCD_VERSION}-linux-amd64
sudo cp etcd etcdctl etcdutl /usr/local/bin/

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
sudo chmod +x /usr/local/bin/etcd /usr/local/bin/etcdctl /usr/local/bin/etcdutl

# –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∫–æ–º–∞–Ω–¥
hash -r

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
sudo mkdir -p /etc/etcd /var/lib/etcd /var/log/etcd
sudo chown -R petcdadms:petcdadms /etc/etcd /var/lib/etcd /var/log/etcd
sudo chmod 700 /etc/etcd /var/lib/etcd /var/log/etcd

# –ù–∞–∑–Ω–∞—á–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
sudo chown -R petcdadms:petcdadms /var/lib/etcd
sudo chown -R petcdadms:petcdadms /etc/etcd
sudo chown -R petcdadms:petcdadms /var/log/etcd

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É:"
/usr/local/bin/etcd --version
/usr/local/bin/etcdctl version
/usr/local/bin/etcdutl version

# –û—á–∏—Å—Ç–∫–∞
cd ..
rm -rf etcd-v${ETCD_VERSION}-linux-amd64 etcd-v${ETCD_VERSION}-linux-amd64.tar.gz
```
![alt text](image-47.png)

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã etcd

**–ù–∞ spbetcd1 (192.168.10.209):**
```bash
sudo tee /etc/etcd/etcd.conf << EOF
# [member]
ETCD_NAME=spbetcd1
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.10.209:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.10.209:2379,https://127.0.0.1:2379"

# [cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.10.209:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.10.209:2379"
ETCD_INITIAL_CLUSTER="spbetcd1=https://192.168.10.209:2380,spbetcd2=https://192.168.10.211:2380,spbetcd3=https://192.168.10.181:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"

# [security]
ETCD_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_KEY_FILE="/etc/etcd/etcd.key"
ETCD_CLIENT_CERT_AUTH="true"
ETCD_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
ETCD_PEER_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_PEER_KEY_FILE="/etc/etcd/etcd.key"
ETCD_PEER_CLIENT_CERT_AUTH="true"
ETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
EOF
```

**–ù–∞ spbetcd2 (192.168.10.211):**
```bash
sudo tee /etc/etcd/etcd.conf << EOF
# [member]
ETCD_NAME=spbetcd2
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.10.211:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.10.211:2379,https://127.0.0.1:2379"

# [cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.10.211:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.10.211:2379"
ETCD_INITIAL_CLUSTER="spbetcd1=https://192.168.10.209:2380,spbetcd2=https://192.168.10.211:2380,spbetcd3=https://192.168.10.181:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"

# [security]
ETCD_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_KEY_FILE="/etc/etcd/etcd.key"
ETCD_CLIENT_CERT_AUTH="true"
ETCD_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
ETCD_PEER_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_PEER_KEY_FILE="/etc/etcd/etcd.key"
ETCD_PEER_CLIENT_CERT_AUTH="true"
ETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
EOF
```

**–ù–∞ spbetcd3 (192.168.10.181):**
```bash
sudo tee /etc/etcd/etcd.conf << EOF
# [member]
ETCD_NAME=spbetcd3
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_PEER_URLS="https://192.168.10.181:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.10.181:2379,https://127.0.0.1:2379"

# [cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.10.181:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.10.181:2379"
ETCD_INITIAL_CLUSTER="spbetcd1=https://192.168.10.209:2380,spbetcd2=https://192.168.10.211:2380,spbetcd3=https://192.168.10.181:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"

# [security]
ETCD_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_KEY_FILE="/etc/etcd/etcd.key"
ETCD_CLIENT_CERT_AUTH="true"
ETCD_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
ETCD_PEER_CERT_FILE="/etc/etcd/etcd.crt"
ETCD_PEER_KEY_FILE="/etc/etcd/etcd.key"
ETCD_PEER_CLIENT_CERT_AUTH="true"
ETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
EOF
```
**–ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å etcd –±–µ–∑ TLS (HTTP, –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è), —Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—è –Ω–∞—Å—Ç—Ä–æ–∏–ª –Ω–æ–¥—ã etcd —Å TLS):**

–ù–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å /etc/etcd/etcd.conf:
```bash
sudo tee /etc/etcd/etcd.conf << EOF
# [member]
ETCD_NAME=spbetcd1  # –∏–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_LISTEN_PEER_URLS="http://192.168.10.209:2380"  # HTTP –≤–º–µ—Å—Ç–æ HTTPS
ETCD_LISTEN_CLIENT_URLS="http://192.168.10.209:2379,http://127.0.0.1:2379"  # HTTP

# [cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://192.168.10.209:2380"  # HTTP
ETCD_ADVERTISE_CLIENT_URLS="http://192.168.10.209:2379"  # HTTP
ETCD_INITIAL_CLUSTER="spbetcd1=http://192.168.10.209:2380,spbetcd2=http://192.168.10.211:2380,spbetcd3=http://192.168.10.181:2380"  # HTTP
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-1"
ETCD_INITIAL_CLUSTER_STATE="new"

# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ TLS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ETCD_CERT_FILE="/etc/etcd/etcd.crt"
# ETCD_KEY_FILE="/etc/etcd/etcd.key"
# ETCD_CLIENT_CERT_AUTH="true"
# ETCD_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
# ETCD_PEER_CERT_FILE="/etc/etcd/etcd.crt"
# ETCD_PEER_KEY_FILE="/etc/etcd/etcd.key"
# ETCD_PEER_CLIENT_CERT_AUTH="true"
# ETCD_PEER_TRUSTED_CA_FILE="/etc/etcd/ca.crt"
EOF
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–Ω–∞ –æ–¥–Ω–æ–º –∏–∑ —É–∑–ª–æ–≤ - spbetcd1, –∑–∞—Ç–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ)

**–ù–∞ spbetcd1:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cfssl
cd /tmp
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64
chmod +x cfssl_1.6.4_linux_amd64 cfssljson_1.6.4_linux_amd64
sudo mv cfssl_1.6.4_linux_amd64 /usr/local/bin/cfssl
sudo mv cfssljson_1.6.4_linux_amd64 /usr/local/bin/cfssljson

# –°–æ–∑–¥–∞–Ω–∏–µ CA
 echo $PATH
/usr/local/bin/cfssl gencert -initca ca-csr.json | /usr/local/bin/cfssljson -bare ca
cat > ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "8760h"
    },
    "profiles": {
      "etcd": {
        "usages": ["signing", "key encipherment", "server auth", "client auth"],
        "expiry": "8760h"
      }
    }
  }
}
EOF

cat > ca-csr.json << EOF
{
  "CN": "ETCD CA",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "RU",
      "L": "SPB",
      "O": "ETCD",
      "OU": "CA",
      "ST": "Russia"
    }
  ]
}
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è etcd
/usr/local/bin/cfssl gencert -initca ca-csr.json | /usr/local/bin/cfssljson -bare ca
cat > etcd-csr.json << EOF
{
  "CN": "etcd",
  "hosts": [
    "127.0.0.1",
    "localhost",
    "spbetcd1",
    "spbetcd2",
    "spbetcd3",
    "192.168.10.209",
    "192.168.10.211",
    "192.168.10.181"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "RU",
      "L": "SPB",
      "O": "ETCD",
      "OU": "Cluster"
    }
  ]
}
EOF

/usr/local/bin/cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | /usr/local/bin/cfssljson -bare etcd

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
sudo cp ca.pem /etc/etcd/ca.crt
sudo cp etcd.pem /etc/etcd/etcd.crt
sudo cp etcd-key.pem /etc/etcd/etcd.key

sudo chown petcdadms:petcdadms /etc/etcd/*.crt /etc/etcd/*.key
sudo chmod 600 /etc/etcd/*.key
```

#### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –Ω–∞ –¥—Ä—É–≥–∏–µ etcd —É–∑–ª—ã

```bash
# –° spbetcd1 –Ω–∞ spbetcd2
sudo scp /etc/etcd/ca.crt petcdadms@spbetcd2:/etc/etcd/
sudo scp /etc/etcd/etcd.crt petcdadms@spbetcd2:/etc/etcd/
sudo scp /etc/etcd/etcd.key petcdadms@spbetcd2:/etc/etcd/

# –° spbetcd1 –Ω–∞ spbetcd3
sudo scp /etc/etcd/ca.crt petcdadms@spbetcd3:/etc/etcd/
sudo scp /etc/etcd/etcd.crt petcdadms@spbetcd3:/etc/etcd/
sudo scp /etc/etcd/etcd.key petcdadms@spbetcd3:/etc/etcd/

# –ù–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
sudo chown petcdadms:petcdadms /etc/etcd/*.crt /etc/etcd/*.key
sudo chmod 600 /etc/etcd/*.key
```

#### –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã –¥–ª—è etcd

**–ù–∞ –≤—Å–µ—Ö etcd —É–∑–ª–∞—Ö:**
```bash
sudo tee /etc/systemd/system/etcd.service << EOF
[Unit]
Description=etcd key-value store
Documentation=https://etcd.io/docs
After=network.target

[Service]
Type=notify
User=psqladmines
EnvironmentFile=-/etc/etcd/etcd.conf
ExecStart=/usr/local/bin/etcd
Restart=always
RestartSec=10s
LimitNOFILE=40000

[Install]
WantedBy=multi-user.target
EOF

# –ù–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ
sudo systemctl daemon-reload
sudo systemctl enable etcd
```

#### –ó–∞–ø—É—Å–∫ etcd –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
# –ó–∞–ø—É—Å–∫ –Ω–∞ –≤—Å–µ—Ö —É–∑–ª–∞—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É
sudo systemctl start etcd

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status etcd

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∏–µ –ø—Ä–æ—Ç–æ–∫–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
sudo netstat -tlnp | grep etcd

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
sudo ETCDCTL_API=3 etcdctl \
  --endpoints="https://192.168.10.209:2379,https://192.168.10.211:2379,https://192.168.10.181:2379" \
  --cacert=/etc/etcd/ca.crt \
  --cert=/etc/etcd/etcd.crt \
  --key=/etc/etcd/etcd.key \
  endpoint health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞
sudo ETCDCTL_API=3 etcdctl --endpoints=https://192.168.10.209:2379 \
  --cacert=/etc/etcd/ca.crt \
  --cert=/etc/etcd/etcd.crt \
  --key=/etc/etcd/etcd.key \
  member list
```
![alt text](image-13.png)
![alt text](image-14.png)


### **3.3. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º Patroni**

#### –ù–∞ —É–∑–ª–∞—Ö PostgreSQL (spbpsql1, spbpsql2)

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è PostgresPro
wget https://repo.postgrespro.ru/1c/1c-17/keys/pgpro-repo-add.sh
sudo sh pgpro-repo-add.sh

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Patroni –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo dnf install -y python3-pip gcc python3-devel
sudo pip3 install patroni[etcd] python-consul

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥—Ä—É–ø–ø
sudo groupadd -g 1001 admindbps
sudo useradd -u 1001 -g admindbps -s /bin/bash -d /var/lib/pgpro/ -m admindbps

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
sudo mkdir -p /var/lib/pgpro/1c-17/data
sudo mkdir -p /var/lib/pgsql/
sudo mkdir -p /var/log/postgresql
sudo mkdir -p /run/postgresql
sudo chown -R psqladmines:psqladmines /var/lib/pgpro/ /var/log/postgresql /opt/pgpro/1c-17/bin /run/postgresql var/lib/pgpro/1c-17/data
sudo chmod -R 0750  /var/lib/pgpro/ /var/log/postgresql /opt/pgpro/1c-17/bin /run/postgresql /var/lib/pgpro/1c-17/data
```
=============================
sudo chown -R admindbps:admindbps /var/lib/pgpro/ /var/log/postgresql /opt/pgpro/1c-17/bin /run/postgresql
sudo mkdir -p /var/lib/pgpro/1c-17/data
sudo chown -R psqladmines:psqladmines /var/lib/pgpro/1c-17/data
sudo chmod -R 777  /var/lib/pgpro/1c-17/data
=============================


#### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Å etcd

```bash
# –ö–æ–ø–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å etcd —É–∑–ª–∞ –Ω–∞–≤ –æ–±–µ –Ω–æ–¥—ã —Å PostgreSQL
sudo scp psqladmines@spbetcd1:/etc/etcd/etcd.crt /var/lib/pgsql/
sudo scp psqladmines@spbetcd1:/etc/etcd/etcd.key /var/lib/pgsql/
sudo scp psqladmines@spbetcd1:/etc/etcd/ca.crt /var/lib/pgsql/

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
sudo chown psqladmines:psqladmines /var/lib/pgsql/*.crt /var/lib/pgsql/*.key
sudo chmod 600 /var/lib/pgsql/etcd.key
sudo chmod 644 /var/lib/pgsql/*.crt
```

==========================================================================
#–¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –∑–æ–Ω—ã –º–æ–∂–µ–º —É–∫–∞–∑–∞—Ç—å!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! 
sudo chmod 744 /var/lib/pgsql/ca.crt
sudo chmod 744 /var/lib/pgsql/etcd.crt
sudo chmod 744 /var/lib/pgsql/etcd.key
sudo chown psqladmines:psqladmines /var/lib/pgsql/ca.crt
sudo chown psqladmines:psqladmines /var/lib/pgsql/etcd.crt
sudo chown psqladmines:psqladmines /var/lib/pgsql/etcd.key
==========================================================================

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Patroni

**–ù–∞ spbpsql1 (192.168.10.204):**
```bash
sudo tee /etc/patroni.yml << 'EOF'
scope: patroni-cluster-1s-zup
namespace: /service/
name: spbpsql1

restapi:
  listen: 192.168.10.204:8008
  connect_address: 192.168.10.204:8008

etcd3:
  hosts: 192.168.10.209:2379,192.168.10.211:2379,192.168.10.181:2379
  protocol: https
  cacert: /var/lib/pgsql/ca.crt
  cert: /var/lib/pgsql/etcd.crt
  key: /var/lib/pgsql/etcd.key
  api_version: v3

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è 1–°)
        max_connections: 200  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        shared_buffers: 4GB
        huge_pages: try
        temp_buffers: 64MB    # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        work_mem: 64MB        # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        maintenance_work_mem: 2GB  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ 1–°
        autovacuum_work_mem: 1GB   
        dynamic_shared_memory_type: posix

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WAL
        wal_level: logical
        synchronous_commit: 'on'
        full_page_writes: 'on'
        wal_log_hints: 'on'
        wal_compression: 'on'
        wal_buffers: 16MB
        wal_writer_delay: 200ms
        commit_delay: 10
        commit_siblings: 5
        max_wal_size: 8GB      # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        min_wal_size: 2GB

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫
        checkpoint_completion_target: 0.9  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        checkpoint_timeout: 15min          

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
        archive_mode: 'on'
        archive_command: '/bin/true'
        max_wal_senders: 10
        max_replication_slots: 10
        hot_standby: 'on'
        hot_standby_feedback: 'on'

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è 1–°
        random_page_cost: 1.1
        effective_cache_size: 12GB
        effective_io_concurrency: 200
        seq_page_cost: 1.0

        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        max_worker_processes: 8           
        max_parallel_workers_per_gather: 4 
        max_parallel_maintenance_workers: 3
        max_parallel_workers: 8

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è 1–°
        default_transaction_isolation: 'read committed'
        lock_timeout: '10s'               # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        statement_timeout: '3600s'
        idle_in_transaction_session_timeout: '1800s' # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        deadlock_timeout: '5s'

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –¥–ª—è 1–°
        autovacuum_naptime: '1min'        
        autovacuum_vacuum_scale_factor: 0.1  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        autovacuum_analyze_scale_factor: 0.05
        autovacuum_vacuum_cost_delay: '20ms'
        autovacuum_vacuum_cost_limit: 2000 –æ
        autovacuum_max_workers: 5         

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–∏—Å–∏
        bgwriter_delay: 50ms              
        bgwriter_lru_maxpages: 1000       
        bgwriter_lru_multiplier: 4.0      

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        log_destination: 'stderr'
        logging_collector: 'on'
        log_directory: '/var/log/postgresql'
        log_filename: 'postgresql-%a.log'
        log_file_mode: 0644
        log_rotation_age: 1d
        log_rotation_size: 0
        log_min_duration_statement: 5000  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è 1–°
        log_checkpoints: 'on'
        log_connections: 'on'
        log_disconnections: 'on'
        log_lock_waits: 'on'
        log_temp_files: 1024              # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã >1MB
        log_autovacuum_min_duration: 5000 # –£–≤–µ–ª–∏—á–µ–Ω–æ

        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        track_io_timing: 'on'
        track_functions: 'all'
        track_activity_query_size: 4096   # –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ 1–°
        shared_preload_libraries: 'pg_stat_statements'

  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã initdb –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–¥–µ—Å—å
  initdb:
    - encoding: UTF8
    - data-checksums
    - locale: ru_RU.UTF-8

  # pg_hba —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
  pg_hba:
    - host replication replicator 192.168.10.0/24 md5
    - host all all 192.168.10.0/24 md5
    - host all all 127.0.0.1/32 md5
    - local all all md5

postgresql:
  listen: 192.168.10.204:5432
  connect_address: 192.168.10.204:5432
  data_dir: /var/lib/pgpro/1c-17/data
  bin_dir: /opt/pgpro/1c-17/bin
  authentication:
    replication:
      username: replicator
      password: 'Keyjkbrbq99!'
    superuser:
      username: admindbps
      password: 'Keyjkbrbq64!'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false   
EOF

sudo chown psqladmines:psqladmines /etc/patroni.yml
```

#### **–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –º–æ—ë–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ Patroni:**

##### **1. –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞**

```yaml
scope: patroni-cluster-1s-zup
namespace: /service/
name: spbpsql1
```

- **`scope`** - –ò–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni. –í—Å–µ –Ω–æ–¥—ã –≤ –æ–¥–Ω–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π scope
- **`namespace`** - –ü—Ä–µ—Ñ–∏–∫—Å –≤ etcd –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (`/service/` = –∫–ª—é—á–∏ –±—É–¥—É—Ç `/service/patroni-cluster-1s-zup/...`)
- **`name`** - –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ç–µ–∫—É—â–µ–π –Ω–æ–¥—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

##### **2. REST API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
REST API - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π HTTP-—Å–µ—Ä–≤–µ—Ä Patroni –¥–ª—è:

- –û–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞

- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

- –ü–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∞—Å—Ç–µ—Ä–µ

```yaml
restapi:
  listen: 192.168.10.204:8008
  connect_address: 192.168.10.204:8008
```

- **`listen`** - IP –∏ –ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è REST API –∑–∞–ø—Ä–æ—Å–æ–≤
- **`connect_address`** - –ê–¥—Ä–µ—Å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –¥—Ä—É–≥–∏–µ –Ω–æ–¥—ã –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ REST API —ç—Ç–æ–π –Ω–æ–¥—ã

##### **3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ etcd3**

```yaml
etcd3:
  hosts: 192.168.10.209:2379,192.168.10.211:2379,192.168.10.181:2379
  protocol: https
  cacert: /var/lib/pgsql/ca.crt
  cert: /var/lib/pgsql/etcd.crt
  key: /var/lib/pgsql/etcd.key
  api_version: v3
```

- **`hosts`** - –°–ø–∏—Å–æ–∫ etcd –Ω–æ–¥ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **`protocol: https`** - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SSL –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- **`cacert/cert/key`** - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **`api_version: v3`** - –í–µ—Ä—Å–∏—è API etcd

–ò–º–µ–Ω–Ω–æ `etcd3` —Å `v3` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª —Å Patroni –∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–º etcd.
etcd - –ø—ã—Ç–∞–ª—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å –≤–µ—Ä—Å–∏–µ–π api `v2` –∏–ª–∏ `v3beta` (–µ—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∂–µ—Å—Ç–∫–æ —É–µ–∞–∑–∞—Ç—å api_version: v3).

##### **4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É—Ç—Å—Ç—Ä–∞–ø–∞ –∏ DCS**

```yaml
bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
```

- **`ttl: 30`** - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –ª–∏–¥–µ—Ä—Å–∫–æ–π —Å–µ—Å—Å–∏–∏ (—Å–µ–∫—É–Ω–¥—ã)
Time To Live (TTL) -—ç—Ç–æ "–∞—Ä–µ–Ω–¥–∞" –ª–∏–¥–µ—Ä—Å—Ç–≤–∞:
- –õ–∏–¥–µ—Ä (master) –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ (loop_wait) –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ—é —Å–µ—Å—Å–∏—é –≤ etcd
- –ï—Å–ª–∏ –ª–∏–¥–µ—Ä –Ω–µ –æ–±–Ω–æ–≤–∏–ª —Å–µ—Å—Å–∏—é –∑–∞ 30 —Å–µ–∫ - —Å—á–∏—Ç–∞–µ—Ç—Å—è –º–µ—Ä—Ç–≤—ã–º
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä –Ω–æ–≤–æ–≥–æ –ª–∏–¥–µ—Ä–∞.

- **`loop_wait: 10`** - –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)
- **`retry_timeout: 10`** - –¢–∞–π–º–∞—É—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (—Å–µ–∫—É–Ω–¥—ã)
- **`maximum_lag_on_failover: 1048576`** - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è —Ñ–µ–π–ª–æ–≤–µ—Ä–∞ (–≤ –±–∞–π—Ç–∞—Ö) = `1–ú–ë` ( –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 32 –ú–ë - –¥–ª—è 1–° —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ).

##### **5. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL**

##### **–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏**
```yaml
max_connections: 200          # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π 1–° (–¥–ª—è –ø–µ—Ä—Å–ø–∏–∫—Ç—ã–≤—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥—Ä—É–≥–∏—Ö –±–∞–∑, –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –≥—Ä—É–ø–ø—ã 60 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 1–° + –∑–∞–ø–∞—Å)
shared_buffers: 4GB           # –ö—ç—à –≤ –æ–±—â–µ–π –ø–∞–º—è—Ç–∏ (25% –æ—Ç 16–ì–ë = 4–ì–ë (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ))
huge_pages: try               # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å huge pages –æ–≥—Ä–æ–º–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–º—è—Ç–∏ (—É–º–µ–Ω—å—à–∞–µ—Ç overhead)
temp_buffers: 64MB            # –ë—É—Ñ–µ—Ä—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü  4MB √ó 200 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π ‚âà 800MB (–Ω–æ –ª–∏–º–∏—Ç 64MB –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
work_mem: 64MB                # –ü–∞–º—è—Ç—å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏/—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (16–ì–ë - 4–ì–ë) / 200 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π √ó 0.5 ‚âà 32MB) - —É–≤–µ–ª–∏—á–∏–ª –¥–æ 64MB –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
maintenance_work_mem: 2GB     # –ü–∞–º—è—Ç—å –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (VACUUM, CREATE INDEX). 6% –æ—Ç 16–ì–ë ‚âà 1–ì–ë (—É–≤–µ–ª–∏—á–∏–ª –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```

##### **WAL (Write-Ahead Log) –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
```yaml
wal_level: logical            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
synchronous_commit: 'on'      # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å WAL
wal_compression: 'on'         # –°–∂–∞—Ç–∏–µ WAL
max_wal_size: 8GB            # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä WAL —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (max_wal_size = shared_buffers √ó 2 = 4GB √ó 2 = 8GB.  –î–ª—è 1–° 8–ì–ë - –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
```

##### **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**
```yaml
max_wal_senders: 10          # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ WAL
max_replication_slots: 10    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ —Å–ª–æ—Ç–æ–≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
hot_standby: 'on'            # –†–∞–∑—Ä–µ—à–∏—Ç—å —á—Ç–µ–Ω–∏–µ –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ö
hot_standby_feedback: 'on'   # –†–µ–ø–ª–∏–∫–∞ —Å–æ–æ–±—â–∞–µ—Ç –æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
```

##### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è 1–°**
```yaml
random_page_cost: 1.1         # –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (SSD)
effective_io_concurrency: 200 # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ IO –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ IO –æ–ø–µ—Ä–∞—Ü–∏–∏ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –¥–∏—Å–∫—É: –î–ª—è SSD: 200-300, –¥–ª—è HDD: 2-8. –£–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É, —á—Ç–æ –¥–∏—Å–∫ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
default_transaction_isolation: 'read committed'  # –£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

##### **–¢–∞–π–º–∞—É—Ç—ã –¥–ª—è 1–°**
```yaml
lock_timeout: '10s'           # –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
statement_timeout: '3600s'    # –¢–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (1 —á–∞—Å)
idle_in_transaction_session_timeout: '1800s'  # –¢–∞–π–º–∞—É—Ç –ø—Ä–æ—Å—Ç–æ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

##### **–ê–≤—Ç–æ–≤–∞–∫—É—É–º –¥–ª—è 1–°**
```yaml
autovacuum_vacuum_scale_factor: 0.1  # –ó–∞–ø—É—Å–∫ VACUUM –ø—Ä–∏ 10% –∏–∑–º–µ–Ω–µ–Ω–∏–π
autovacuum_max_workers: 5     # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞
autovacuum_vacuum_cost_limit: 2000  # –õ–∏–º–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ (–î–ª—è 1–° —Å —á–∞—Å—Ç—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ - –∑–Ω–∞—á–µ–Ω–∏–µ 2000 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
```

##### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
```yaml
log_min_duration_statement: 5000  # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (>5 —Å–µ–∫)
log_lock_waits: 'on'          # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
track_io_timing: 'on'         # –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Ä–µ–º—è IO –æ–ø–µ—Ä–∞—Ü–∏–π
shared_preload_libraries: 'pg_stat_statements'  # –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
```

##### **6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î**

```yaml
initdb:
  - encoding: UTF8
  - data-checksums
  - locale: ru_RU.UTF-8
```

- **`encoding: UTF8`** - –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **`data-checksums`** - –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
- **`locale: ru_RU.UTF-8`** - –õ–æ–∫–∞–ª—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫

##### **7. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (pg_hba)**

```yaml
pg_hba:
  - host replication replicator 192.168.10.0/24 md5
  - host all all 192.168.10.0/24 md5
```

- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∏–∑ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π) –ø–æ–¥—Å–µ—Ç–∏ 192.168.10.0/24
- md5 –≤–º–µ—Å—Ç–æ scram-sha-256 (–±–æ–ª–µ–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª) - –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
-  –®–∏—Ä–æ–∫–∏–π –¥–æ—Å—Ç—É–ø "all all" - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ä–µ–¥.
- –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```bash
pg_hba:
  # –†–µ–ø–ª–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - host replication replicator 192.168.10.209,192.168.10.211,192.168.10.181 scram-sha-256
  - host replication replicator 192.168.10.204 scram-sha-256
  
  # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è 1–°
  - host all 1c_user 192.168.10.0/24 scram-sha-256
  - host all zap_user 192.168.10.0/24 scram-sha-256
  
  # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö IP
  - host all admindbps 192.168.10.100 scram-sha-256
  ```

##### **8. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL –ø—Ä–æ—Ü–µ—Å—Å–∞**

```yaml
postgresql:
  listen: 192.168.10.204:5432
  data_dir: /var/lib/pgpro/1c-17/data
  bin_dir: /opt/pgpro/1c-17/bin
```

- **`data_dir`** - –ö–∞—Ç–∞–ª–æ–≥ —Å –¥–∞–Ω–Ω—ã–º–∏ PostgreSQLPro
- **`bin_dir`** - –ö–∞—Ç–∞–ª–æ–≥ —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ PostgreSQLPro

##### **9. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**

```yaml
authentication:
  replication:
    username: replicator
    password: 'Keyjkbrbq99!'
  superuser:
    username: admindbps
    password: 'Keyjkbrbq64!'
```

- –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

##### **10. –¢–µ–≥–∏ –Ω–æ–¥—ã**

```yaml
tags:
  nofailover: false    # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ñ–µ–π–ª–æ–≤–µ—Ä
  noloadbalance: false # –†–∞–∑—Ä–µ—à–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏
  clonefrom: false     # –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —ç—Ç–æ–π –Ω–æ–¥—ã
  nosync: false        # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è
```

###### **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è 1–°:**

1. **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã** - –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π 1–°
2. **–ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π** - work_mem, maintenance_work_mem
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–≤–∞–∫—É—É–º** - –¥–ª—è —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ 1–°
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç
5. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ø–æ–∏—Å–∫

–≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É PostgreSQL –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ Patroni —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–¥ —Ç–∏–ø–∏—á–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º 1–°.


#### **–ù–∞ spbpsql2 (192.168.10.207):**
```bash
sudo tee /etc/patroni.yml << 'EOF'
scope: patroni-cluster-1s-zup
namespace: /service/
name: spbpsql2

restapi:
  listen: 192.168.10.207:8008
  connect_address: 192.168.10.207:8008

etcd3:
  hosts: 192.168.10.209:2379,192.168.10.211:2379,192.168.10.181:2379
  protocol: https
  cacert: /var/lib/pgsql/ca.crt
  cert: /var/lib/pgsql/etcd.crt
  key: /var/lib/pgsql/etcd.key
  api_version: v3

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è 1–°)
        max_connections: 200
        shared_buffers: 4GB
        huge_pages: try
        temp_buffers: 64MB
        work_mem: 64MB
        maintenance_work_mem: 2GB
        autovacuum_work_mem: 1GB
        dynamic_shared_memory_type: posix

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WAL
        wal_level: logical
        synchronous_commit: 'on'
        full_page_writes: 'on'
        wal_log_hints: 'on'
        wal_compression: 'on'
        wal_buffers: 16MB
        wal_writer_delay: 200ms
        commit_delay: 10
        commit_siblings: 5
        max_wal_size: 8GB
        min_wal_size: 2GB

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫
        checkpoint_completion_target: 0.9
        checkpoint_timeout: 15min

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
        archive_mode: 'on'
        archive_command: '/bin/true'
        max_wal_senders: 10
        max_replication_slots: 10
        hot_standby: 'on'
        hot_standby_feedback: 'on'

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è 1–°
        random_page_cost: 1.1
        effective_cache_size: 12GB
        effective_io_concurrency: 200
        seq_page_cost: 1.0

        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        max_worker_processes: 8
        max_parallel_workers_per_gather: 4
        max_parallel_maintenance_workers: 3
        max_parallel_workers: 8

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è 1–°
        default_transaction_isolation: 'read committed'
        lock_timeout: '10s'
        statement_timeout: '3600s'
        idle_in_transaction_session_timeout: '1800s'
        deadlock_timeout: '5s'

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –¥–ª—è 1–°
        autovacuum_naptime: '1min'
        autovacuum_vacuum_scale_factor: 0.1
        autovacuum_analyze_scale_factor: 0.05
        autovacuum_vacuum_cost_delay: '20ms'
        autovacuum_vacuum_cost_limit: 2000
        autovacuum_max_workers: 5

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–∏—Å–∏
        bgwriter_delay: 50ms
        bgwriter_lru_maxpages: 1000
        bgwriter_lru_multiplier: 4.0

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        log_destination: 'stderr'
        logging_collector: 'on'
        log_directory: '/var/log/postgresql'
        log_filename: 'postgresql-%a.log'
        log_file_mode: 0644
        log_rotation_age: 1d
        log_rotation_size: 0
        log_min_duration_statement: 5000
        log_checkpoints: 'on'
        log_connections: 'on'
        log_disconnections: 'on'
        log_lock_waits: 'on'
        log_temp_files: 1024
        log_autovacuum_min_duration: 5000

        # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        track_io_timing: 'on'
        track_functions: 'all'
        track_activity_query_size: 4096
        shared_preload_libraries: 'pg_stat_statements'

  # –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–û–õ–¨–ö–û –ù–ê spbpsql1 - –Ω–∞ spbpsql2 –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º!
  # initdb:
  #   - encoding: UTF8
  #   - data-checksums
  #   - locale: ru_RU.UTF-8

  pg_hba:
    - host replication replicator 192.168.10.0/24 md5
    - host all all 192.168.10.0/24 md5
    - host all all 127.0.0.1/32 md5
    - local all all md5

postgresql:
  listen: 192.168.10.207:5432
  connect_address: 192.168.10.207:5432
  data_dir: /var/lib/pgpro/1c-17/data
  bin_dir: /opt/pgpro/1c-17/bin
  authentication:
    replication:
      username: replicator
      password: 'Keyjkbrbq99!'
    superuser:
      username: admindbps
      password: 'Keyjkbrbq64!'

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
EOF

sudo chown psqladmines:psqladmines /etc/patroni.yml
```

#### –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã –¥–ª—è Patroni

**–ù–∞ –æ–±–æ–∏—Ö —É–∑–ª–∞—Ö PostgreSQL:**
```bash
sudo tee /etc/systemd/system/patroni.service << EOF
[Unit]
Description=Patroni PostgreSQL High Availability
After=syslog.target network.target

[Service]
Type=simple
User=psqladmines
Group=psqladmines
ExecStart=/usr/local/bin/patroni /etc/patroni.yml
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
TimeoutSec=30
Restart=no
RestartSec=10s
WorkingDirectory=/home/psqladmines

#Limit settings
LimitNOFILE=infinity
LimitNPROC=infinity

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
```

#### –ó–∞–ø—É—Å–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni

##### –ó–∞–ø—É—Å–∫ Patroni

```bash
# –ù–∞ spbpsql1 (–ø–µ—Ä–≤—ã–π —É–∑–µ–ª)
sudo systemctl enable patroni
sudo systemctl start patroni

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status patroni

# –ù–∞ spbpsql2 (–≤—Ç–æ—Ä–æ–π —É–∑–µ–ª)
sudo systemctl enable patroni
sudo systemctl start patroni
```
![alt text](image-33.png)

##### **–ü—Ä–æ–±–ª–µ–º—ã:**
–ë—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞:
1) –Ω—É–∂–Ω–∞ –±—ã–ª–∞ –≤–µ—Å–∏—è etcd3, –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫–ª–∞—Å—Ç–µ—Ä –∫ –∫–ª–∞—Å—Ç–µ—Ä—É DCS:
```bash
sudo pip3 uninstall -y python-etcd etcd3
sudo pip3 install etcd3
sudo pip3 uninstall -y patroni
sudo pip3 install patroni[etcd3]
sudo systemctl daemon-reload
```

2) –∫–ª–∞—Å—Ç–µ—Ä Patroni –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É etcd, —Ç.–∫. Patroni –ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API V2, –∞ etcd —Ä–∞–±–æ—Ç–∞–µ—Ç —Å V3, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ ` /etc/patroni.yml` –¥–æ–±–∞–≤–∏—Ç—å 1—É —Å—Ç—Ä–æ—á–∫—É (—á—Ç–æ–±—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å V3):
etcd3:
   api_version: v3

3) –Ω–∞ 2–π –Ω–æ–¥–µ spbpsql –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥  `/var/lib/pgsql/17/data/`, —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±–æ–≤–∞–ª–∞ 0700 –∏–ª–∏ 0750, –∏–Ω–∞—á–µ, PAtroni –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª (–ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–∞ –≤–µ—Ä—Å–∏–∏ PostgreSQL 17 Standard):
```bash
sudo systemctl stop patroni
sudo rm -rf /var/lib/pgsql/17/data/*
sudo chmod -R 0750 /var/lib/pgsql/17/data/
sudo chown psqladmines:psqladmines /var/lib/pgsql/17/data/
sudo systemctl start patroni
```

4) –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º PostgreSQL –Ω–∞ spbpsql2 (replica). –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "start failed" –∏ "postmaster is not running". PostgreSQL –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å lock —Ñ–∞–π–ª –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /run/postgresql/ :

```bash
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Patroni
sudo systemctl stop patroni

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ–∫–µ—Ç–æ–≤ PostgreSQL
sudo mkdir -p /run/postgresql
sudo chown psqladmines:psqladmines /run/postgresql
sudo chmod 755 /run/postgresql

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
sudo ls -la /run/postgresql
sudo systemctl start patroni
```
5) –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ—Ä—Ç–∞ `5432` –Ω–∞ spbpsql2, –±—ã–ª –ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥ (–Ω–µ—Ç  –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ–∫–µ—Ç–æ–≤ –≤ /etc/patroni.yml), patroni –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è:
```bash
 sudo netstat -tlnp | grep 5432

#–¥–æ–±–∞–≤–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä unix_socket_directories –≤  nano /etc/patroni.yml
parameters:
    unix_socket_directories: '/run/postgresql'

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ lock —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
sudo rm -f /run/postgresql/.s.PGSQL.5432.*
sudo rm -f /tmp/.s.PGSQL.5432.*

sudo systemctl start patroni
sudo systemctl status patroni

```
![alt text](image-15.png) 

##### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ PostgreSQL
sudo tail -f /var/log/postgresql/postgresql-*.log

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep postgres

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
sudo netstat -tlnp | grep 5432

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
curl http://192.168.10.204:8008/cluster | jq .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞
curl http://192.168.10.204:8008/patroni | jq .
curl http://192.168.10.207:8008/patroni | jq .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ etcd
sudo ETCDCTL_API=3 etcdctl --endpoints=https://192.168.10.209:2379 \
  --cacert=/etc/etcd/ca.crt \
  --cert=/etc/etcd/etcd.crt \
  --key=/etc/etcd/etcd.key \
  get "/service/patroni-cluster-1s-zup/" --prefix
```
![alt text](image-16.png)
![alt text](image-17.png)
![alt text](image-18.png)

##### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞:

##### ‚úÖ **spbpsql1 (MASTER):**
- –°–æ—Å—Ç–æ—è–Ω–∏–µ: `running`
- –†–æ–ª—å: `leader` 
- Timeline: 2
- PostgreSQL —É—Å–ø–µ—à–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

##### ‚úÖ **spbpsql2 (REPLICA):**
- –°–æ—Å—Ç–æ—è–Ω–∏–µ: `running`
- –†–æ–ª—å: `replica`
- Timeline: 2
- –†–µ–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç: `receive_lag: 0`, `replay_lag: 0`
- PostgreSQL —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

##### ‚úÖ **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è:**
- WAL streaming —Ä–∞–±–æ—Ç–∞–µ—Ç
- Lag —Ä–∞–≤–µ–Ω 0 - –æ—Ç–ª–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –û–±–∞ —É–∑–ª–∞ –Ω–∞ –æ–¥–Ω–æ–º timeline

##### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

###### 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ:

```bash
# –ù–∞ spbpsql1 –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏
psql -h 192.168.10.204 -U admindbps -d postgres -c "SELECT client_addr, state, sync_state, write_lag, flush_lag, replay_lag FROM pg_stat_replication;"
```
![alt text](image-19.png)

###### 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ä–µ–ø–ª–∏–∫–µ:

```bash
# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ä–µ–ø–ª–∏–∫–µ (spbpsql2) - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
psql -h 192.168.10.207 -U admindbps -d postgres -c "SELECT pg_is_in_recovery();"
```
![alt text](image-20.png)

###### 3. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é:

```bash
# –ù–∞ –º–∞—Å—Ç–µ—Ä–µ (spbpsql1) —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É
psql -h 192.168.10.204 -U admindbps -d postgres -c "CREATE DATABASE test_replication;"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ (spbpsql2) —á—Ç–æ –±–∞–∑–∞ –ø–æ—è–≤–∏–ª–∞—Å—å
psql -h 192.168.10.207 -U admindbps -d postgres -c "\l"
```
![alt text](image-21.png)
![alt text](image-22.png)

###### **–ü—Ä–æ–±–ª–µ–º—ã:**
–ë—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞, –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ Patroni, –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è, —Å–æ–∑–¥–∞—é –±–∞–∑—É –Ω–∞ spbpsql1, –∞ –Ω–∞ spbpsql2 –æ–Ω–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è. –†–µ—à–µ–Ω–∏–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–ø–ª–∏–∫—É:
```bash
# –ù–∞ spbpsql2 –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Patroni
sudo systemctl stop patroni

# –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ
sudo rm -rf /var/lib/pgsql/17/data/*
sudo chown psqladmines:psqladmines /var/lib/pgsql/17/data
sudo chmod 0750 /var/lib/pgsql/17/data

# –ó–∞–ø—É—Å–∫–∞–µ–º Patroni - –æ–Ω –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –º–∞—Å—Ç–µ—Ä–æ–º
sudo systemctl start patroni

# –°–ª–µ–¥–∏–º –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
sudo journalctl -u patroni -f
```
###### –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

```bash
# –ù–∞ spbpsql1 –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–ª–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω
psql -h 192.168.10.204 -U admindbps -d postgres -c "SELECT slot_name, slot_type, active, restart_lsn, confirmed_flush_lsn FROM pg_replication_slots;"
```
![alt text](image-24.png)

### –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–ø–ª–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è

```bash
# –ù–∞ spbpsql2 –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–ø–ª–∏–∫–∏
psql -h 192.168.10.207 -U admindbps -d postgres -c "SELECT pg_is_in_recovery();"

# –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)
psql -h 192.168.10.207 -U admindbps -d postgres -c "CREATE TABLE test_table (id serial);"
```
![alt text](image-25.png)

###### –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ (failover)

```bash
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Patroni –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ (spbpsql1)
sudo systemctl stop patroni

# –ù–∞ spbpsql2 –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω —Å—Ç–∞–ª –º–∞—Å—Ç–µ—Ä–æ–º
curl http://192.168.10.207:8008/patroni | jq .role

# –ó–∞–ø—É—Å–∫–∞–µ–º Patroni –Ω–∞ spbpsql1 –æ–±—Ä–∞—Ç–Ω–æ - –æ–Ω –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å —Ä–µ–ø–ª–∏–∫–æ–π
sudo systemctl start patroni
curl http://192.168.10.204:8008/patroni | jq .role
```
![alt text](image-34.png)

##### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

###### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Patroni

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Patroni
sudo systemctl restart patroni

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
sudo journalctl -u patroni -f

# –†—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
curl -s -X POST http://192.168.10.204:8008/switchover -d '{"leader": "spbpsql1", "candidate": "spbpsql2"}'

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞
curl -s -X POST http://192.168.10.204:8008/restart -d '{"role": "master"}'
```

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö —É–∑–ª–æ–≤
curl -s http://192.168.10.204:8008/cluster | jq '.members[] | {name: .name, role: .role, state: .state, host: .host}'
# –∏–ª–∏
curl -s http://192.168.10.204:8008/cluster | jq .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
curl -s http://192.168.10.204:8008/history | jq .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
curl -s http://192.168.10.204:8008/config | jq .

# –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–æ–¥–µ
curl -s http://192.168.10.204:8008/ | jq .
```
![alt text](image-26.png)

###### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pgBackRest
sudo dnf install -y pgbackrest

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è backup
sudo tee /etc/pgbackrest.conf << EOF
[global]
repo1-path=/var/lib/pgbackrest
repo1-retention-full=2
process-max=2
log-level-console=info
log-level-file=debug

[patroni-cluster-1s-zup]
pg1-path=/var/lib/pgpro/1c-17/data
pg1-port=5432
EOF
```
###### –°–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
cat > /tmp/check_patroni.sh << 'EOF'
#!/bin/bash

echo "=== Patroni Cluster Status ==="
curl -s http://192.168.10.204:8008/cluster | jq '{
  cluster_state: .state,
  leader: .members[] | select(.role == "leader") | .name,
  members: .members | map({name: .name, role: .role, state: .state, lag: .lag})
}'

echo -e "\n=== Switchover History ==="
curl -s http://192.168.10.204:8008/history | jq .

echo -e "\n=== Current Node Status ==="
curl -s http://192.168.10.204:8008/ | jq '{
  state: .state,
  role: .role,
  server_version: .server_version,
  xlog: .xlog
}'
EOF

chmod +x /tmp/check_patroni.sh
/tmp/check_patroni.sh
```

### **3.4. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 1–°:–ó–£–ü**

#### –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è 1–°

```bash
# –ù–∞ —Ç–µ–∫—É—â–µ–º –º–∞—Å—Ç–µ—Ä–µ —Å–æ–∑–¥–∞—é –∞–¥–º–∏–Ω–∞ –∏ –±–∞–∑—É –¥–ª—è 1–°
#–∏–ª–∏: —Å–æ–∑–¥–∞–¥–∏–º –ø–∞–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "
CREATE USER zupadmines WITH PASSWORD 'Jlbycfy37!';"
# –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–∫–∞–ª—å—é
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "CREATE DATABASE \"hr_test_psql2\" OWNER zupadmines ENCODING 'UTF8' LC_COLLATE 'ru_RU.UTF-8' LC_CTYPE 'ru_RU.UTF-8' TEMPLATE template0;"
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE \"hr_test_psql\" TO zupadmines;"

# –∏–ª–∏
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "
CREATE USER zupadmines WITH PASSWORD 'Jlbycfy37!';
CREATE DATABASE  \"hr_test_psql\" OWNER zupadmines ENCODING 'UTF8' LC_COLLATE 'ru_RU.UTF-8' LC_CTYPE 'ru_RU.UTF-8' TEMPLATE template0;
GRANT ALL PRIVILEGES ON DATABASE  \"hr_test_psql\" TO zupadmines;
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–∞–∑–∞ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–ª–∞—Å—å
psql -h 192.168.10.207 -U admindbps -d postgres -c "\l "hr_test_psql""
```
![alt text](image-48.png)


#### **–ü—Ä–æ–±–ª–µ–º—ã**: 
1) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π:
```bash
postgres=# create database 1C_hr_test_psql owner zupadmines;
ERROR:  trailing junk after numeric literal at or near "1C_hr_test_psql"
LINE 1: create database 1C_hr_test_psql owner zupadmines;
                    ^
```
–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `1C_hr_test_psql` –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã. –í PostgreSQL —Ç–∞–∫–∏–µ –∏–º–µ–Ω–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –∏ —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: `CREATE DATABASE "1C_hr_test_psql" OWNER zupadmines;`
–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, —è —Ä–µ—à–∏–ª —É–±—Ä–∞—Ç—å —É–±—Ä–∞—Ç—å —Ü–∏—Ñ—Ä—É –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –±–∞–∑—ã.

2) —Ç–∞–∫–∂–µ –±—ã–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —è —Å–æ–∑–¥–∞–ª –±–∞–∑—É –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª –µ—ë –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–∫ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É" –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 1–°:

![alt text](image-28.png)

–ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π:
```bash
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "
DROP DATABASE IF EXISTS \""hr_tes_psql\";

/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "
CREATE DATABASE \"hr_tes_psql\"
OWNER zupadm 
ENCODING 'UTF8' 
LC_COLLATE 'ru_RU.UTF-8' 
LC_CTYPE 'ru_RU.UTF-8'
TEMPLATE template0;"
```
3) –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É" –±–∞–∑—É psql, –≤—Å–ø–ª—ã–≤–∞–ª–∞ –æ—à–∏–±–∫–∞:

![alt text](image-29.png)

![alt text](image-30.png)

–¢—É—Ç –±—ã–ª–æ 2–µ –ø—Ä–æ–±–ª–µ–º—ã:
- PostgreSQL 17 Standard - –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å 1–°, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É –æ—Ç PostgreSQLPro 17 (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç —Ä–∞–∑—Ä–∞–±–æ—á–∏–∫–æ–≤ 1–°).
- –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π Patroni –¥–ª—è PostgreSQLPro –∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã. –î–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –±–∞–∑—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è `ru_RU.UTF-8`:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Patroni –Ω–∞ –æ–±–æ–∏—Ö —É–∑–ª–∞—Ö
sudo systemctl stop patroni

# –û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ PostgreSQL –Ω–∞ –û–ë–û–ò–• —É–∑–ª–∞—Ö
sudo rm -rf /var/lib/pgpro/1c-17/data/*

# –û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ Patroni –∏–∑ etcd
python3 -c "
import etcd3
client = etcd3.client(
    host='192.168.10.209',
    port=2379,
    ca_cert='/var/lib/pgsql/ca.crt',
    cert_cert='/var/lib/pgsql/etcd.crt', 
    cert_key='/var/lib/pgsql/etcd.key'
)
# –£–¥–∞–ª–∏–º –≤—Å–µ –∫–ª—é—á–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
for value, metadata in client.get_prefix('/service/patroni-cluster-1s-zup'):
    print(f'Deleting: {metadata.key.decode()}')
    client.delete(metadata.key)
print('ETCD data cleaned')
"
#–¥–æ–±–∞–≤–∏–ª –≤ –∫–æ–Ω—Ñ–∏–≥ nano /etc/patroni.yaml:

 # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ initdb –¥–ª—è 1–°
  initdb:
    - encoding: UTF8
    - data-checksums
    - locale: ru_RU.UTF-8

# –ó–∞–ø—É—Å—Ç–∏–ª —Å–Ω–∞—á–∞–ª–∞ –Ω–∞ spbpsql1
sudo systemctl start patroni

# –°–ª–µ–¥–∏–º –∑–∞ –ª–æ–≥–∞–º–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
sudo journalctl -u patroni -f

# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è:
# - "initializing a new cluster"
# - "The database cluster will be initialized with locale ru_RU.UTF-8"

#–ü—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–∫–∞–ª—å –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
# –ü—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–∫–∞–ª—å template1 –±–∞–∑—ã (–æ—Å–Ω–æ–≤–Ω–æ–π —à–∞–±–ª–æ–Ω)
/opt/pgpro/1c-17/bin/psql -h 192.168.10.204 -U admindbps -d postgres -c "
SELECT 
    datname,
    datcollate,
    datctype
FROM pg_database 
WHERE datname IN ('template1', 'template0', 'postgres');"

# –ó–∞–ø—É—Å—Ç–∏–ª spbpsql2
sudo systemctl start patroni
```
![alt text](image-31.png)


### –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
curl http://192.168.10.204:8008/cluster | jq .
```
![alt text](image-35.png)

–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ, –≤–æ–∑–≤—Ä–∞—â–∞—é spbpsql1 —Ä–æ–ª—å `leader`:

```bash
# –ò–º–∏—Ç–∏—Ä—É–µ–º –æ—Ç–∫–∞–∑ –º–∞—Å—Ç–µ—Ä–∞
curl -s -X POST http://192.168.10.207:8008/switchover -d '{"leader": "spbpsql2", "candidate": "spbpsql1"}'
```
![alt text](image-37.png)

#### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ:

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è** - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏  
‚úÖ **–í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö  
‚úÖ **Read-only —Ä–µ–ø–ª–∏–∫–∞** - spbpsql2 –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è  
‚úÖ **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ etcd** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∞  
‚úÖ **REST API** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ HTTP  
‚úÖ **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è 1–°** - —Å–æ–∑–¥–∞–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ó–£–ü  

#### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±—ç–∫–∞–ø—ã** (pgBackRest, barman)
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (Prometheus, Grafana)
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç–∏–Ω–≥** –ø—Ä–∏ —Å–±–æ—è—Ö
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å PgBouncer** –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
6. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∫—É –æ—Ç–∫–∞–∑–æ–≤** –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

 –ö–ª–∞—Å—Ç–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å 1–° –ó–£–ü.


#### –ü–µ—Ä–µ–Ω–æ—Å –±–∞–∑ 1–° —Å MS SQL Server –Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL

–î–ª—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —è –≤—ã–±—Ä–∞–ª —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ –≤—ã–≥—Ä—É–∑–∫—É/–∑–∞–≥—Ä—É–∑–∫—É `.dt` , —Ç.–∫. –æ–Ω:

- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å - —Ä–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç 1–°

- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ - –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ - –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –º–µ—Ç–æ–¥–∏–∫–∞

**–ú–∏–≥—Ä–∞—Ü–∏—é —Ä–∞–∑–±–∏–ª –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã:**

0.  **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞** 
1.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL**
2.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∞–∑—ã 1–° –Ω–∞ —Å—Ç–∞—Ä–æ–º —Å–µ—Ä–≤–µ—Ä–µ**
3.  **–í—ã–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –≤ .dt —á–µ—Ä–µ–∑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä**
4.  **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—É—Å—Ç–æ–π –±–∞–∑—ã –Ω–∞ PostgreSQL**
5.  **–ó–∞–≥—Ä—É–∑–∫–∞ .dt —Ñ–∞–π–ª–∞ –≤ –Ω–æ–≤—É—é –±–∞–∑—É —á–µ—Ä–µ–∑ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä**
6.  **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**


#### –≠—Ç–∞–ø 0: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ 1–° –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
    *   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—Å—è, —á—Ç–æ –Ω–∞—à–∞ –≤–µ—Ä—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ (—Å–µ—Ä–≤–µ—Ä –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä) **–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PostgreSQLPro 17**. –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1–° –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ 1–°:8.3.22 –∏ –Ω–æ–≤–µ–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å PostgreSQLPro 17:

    –ò—Å—Ç–æ—á–Ω–∏–∫: https://v8.1c.ru/tekhnologii/systemnye-trebovaniya-1s-predpriyatiya-8/subd/?

    ![alt text](image-38.png)

2.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –¥–ª—è 1–°:**
    *   1–° –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQLPro —Ç—Ä–µ–±—É–µ—Ç ODBC-–¥—Ä–∞–π–≤–µ—Ä `psqlODBC` 
    *   **–í–∞–∂–Ω–æ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **–æ–¥–∏–Ω–∞–∫–æ–≤—É—é** –≤–µ—Ä—Å–∏—é —ç—Ç–æ–≥–æ –¥—Ä–∞–π–≤–µ—Ä–∞:
        *   –ù–∞ –æ–±–∞ —É–∑–ª–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL (`spbpsql1`, `spbpsql2`).
        *   –ù–∞ —Å–µ—Ä–≤–µ—Ä 1–° (Windows Server 2022).

##### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ODBC –¥—Ä–∞–π–≤–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä 1–°
–ó–∞–≥—Ä—É–∂–∞—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ñ–∞–π–ª –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –¥–ª—è 1–° —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —Å—Å—ã–ª–∫–µ: <br>
https://ftp.postgresql.org/pub/odbc/releases/REL-17_00_0006/psqlodbc-setup.exe

##### –ü–æ—á–µ–º—É —è –≤—ã–±—Ä–∞–ª –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ REL-17_00_0006
##### –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É REL-17_00_0006 –∏ REL-17_00_0006-mimalloc:

##### REL-17_00_0006 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ Windows** (–æ–±—ã—á–Ω–æ HeapAlloc/HeapFree)
- –≠—Ç–æ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–µ–º –≤–∞—Ä–∏–∞–Ω—Ç
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –ú–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ –Ω–∏–∑–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å –ø–∞–º—è—Ç—å—é

##### REL-17_00_0006-mimalloc (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **mimalloc** - –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ –æ—Ç Microsoft
- **mimalloc** (Microsoft's malloc) - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ mimalloc:
  - –ù–∞ 10-25% –±—ã—Å—Ç—Ä–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞
  - –õ—É—á—à–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞
  - –ú–µ–Ω—å—à–∞—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
  - –û—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

##### –î–ª—è 1–° —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: **REL-17_00_0006 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è)**

**–ü—Ä–∏—á–∏–Ω—ã:**

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –í –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö, –æ—Å–æ–±–µ–Ω–Ω–æ —Å 1–°, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã.

2. **–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ª—É—á—à–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏, –≤–∫–ª—é—á–∞—è 1–°.

3. **–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤**: mimalloc - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω—é–∞–Ω—Å—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏.

4. **1–° –Ω–µ —Å–∏–ª—å–Ω–æ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç**: 1–° –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º —Å —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π —Å –ø–∞–º—è—Ç—å—é, –≥–¥–µ mimalloc –¥–∞–≤–∞–ª –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç.

##### –ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ PostgreSQL

–í –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–±—ã—á–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:

- **mimalloc** –≤–µ—Ä—Å–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –¥–ª—è:
  - –í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  - –°–∏—Å—Ç–µ–º —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  - –°—Ü–µ–Ω–∞—Ä–∏–µ–≤, –≥–¥–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é —è–≤–ª—è–µ—Ç—Å—è —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º

- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ** –≤–µ—Ä—Å–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –¥–ª—è:
  - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  - –°–∏—Å—Ç–µ–º, –≥–¥–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1
  - –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

##### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ODBC-–¥—Ä–∞–π–≤–µ—Ä–∞ –Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL

–ù–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–≤–∞ –ø–∞–∫–µ—Ç–∞: **unixODBC** (–±–∞–∑–æ–≤—ã–π –¥—Ä–∞–π–≤–µ—Ä) –∏ **ODBC-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQL**.

 1. –£—Å—Ç–∞–Ω–æ–≤–∏–º unixODBC:

```bash
dnf install -y unixODBC unixODBC-devel
```
`unixODBC` - —ç—Ç–æ "–º–µ–Ω–µ–¥–∂–µ—Ä –¥—Ä–∞–π–≤–µ—Ä–æ–≤" –¥–ª—è Linux.

**unixODBC:**
- unixODBC –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–∞ –º–µ–∂–¥—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ –ë–î

- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

- –£–ø—Ä–∞–≤–ª—è–µ—Ç –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (DSN)

```bash
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (1–°) ‚Üí unixODBC ‚Üí –î—Ä–∞–π–≤–µ—Ä PostgreSQL ‚Üí –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```

2. –£—Å—Ç–∞–Ω–æ–≤–∏–º ODBC-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQLPro 17:

```bash

# –û—Ç–∫–ª—é—á–∏–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å PostgreSQL, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
dnf -qy module disable postgresql

# –£—Å—Ç–∞–Ω–æ–≤–∏–º ODBC-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQLPro 17
dnf install -y postgresql17-odbc
```

3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ unixODBC —É—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
which odbcinst
odbcinst -j

# –ü—Ä–æ–≤–µ—Ä–∏–º –¥—Ä–∞–π–≤–µ—Ä—ã PostgreSQL
odbcinst -q -d

# –ü—Ä–æ–≤–µ—Ä–∏–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
rpm -qa | grep -E '(odbc|postgre)'
```
![alt text](image-39.png)

![alt text](image-40.png)

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∫–æ–º–∞–Ω–¥ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ ODBC-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è PostgreSQLPro 17, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è 1–°.
 
#### –≠—Ç–∞–ø 1: –í—ã–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∏–∑ MS SQL Server 2007

1.  **–î–ª—è –ó–£–ü (—Å MS SQL 2007):**
    *   –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ 1–° –∑–∞—Ö–æ–∂—É –≤ –∫–æ–Ω—Å–æ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º 1–° –∏ –¥–æ–±–∞–≤–ª—è—é –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É
    *    –≤ 1C –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫  "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–∞–∑–µ" `hr_test_psql`.
    *    –û—Ç–∫—Ä—ã–≤–∞—é —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É —Å –±–∞–∑–æ–π 1—Å –ó–£–ü –Ω–∞ MS SQL Server 2007  –≤ —Ä–µ–∂–∏–º–µ "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä".
    *   –ú–µ–Ω—é -> **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** -> **–í—ã–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É...**
    *   –°–æ—Ö—Ä–∞–Ω—è—é —Ñ–∞–π–ª `ZUP_To_Postgres.dt`.

![alt text](image-41.png) <br>
![alt text](image-49.png) 
![alt text](image-51.png)

#### –≠—Ç–∞–ø 2: –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL

**–î–ª—è –ó–£–ü:**
       –û—Ç–∫—Ä—ã–≤–∞—é —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É `hr_test_psql1`  –≤ —Ä–µ–∂–∏–º–µ "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä". –í "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä–µ" 1–° –≤—ã–±–µ—Ä–∞—é –º–µ–Ω—é -> **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** -> **–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É...**
    
     –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –Ω–∞—á–Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `.dt` —Ñ–∞–π–ª–∞ –≤ –Ω–æ–≤—É—é –±–∞–∑—É PostgreSQL.

### **3.5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞**

  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏:** –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É 1–°:
    1.  –ù–∞ `spbpsql1`  –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `systemctl stop patroni` 
    2.  Patroni –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–∞—Å—Ç–µ—Ä –Ω–∞ –≤—Ç–æ—Ä–æ–π —É–∑–µ–ª. 

![alt text](image-43.png)

![alt text](image-44.png)

–í 1–° –ø—Ä–∏–¥—ë—Ç—Å—è –ø–µ—Ä–µ–∑–∞–π—Ç–∏ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –±–∞–∑—É  `hr_test_psql2`. –î–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º HAProxy –∏ PgBouncer.

#### –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HAProxy/PgBouncer
–î–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–¥ –∫–ª–∞—Å—Ç–µ—Ä–æ–º:
- **HAProxy**: –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ —á–∏—Ç–∞—é—â–∏—Ö/–ø–∏—à—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **PgBouncer**: –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

#### **HAProxy - –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π**
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç HAProxy:**
- ‚úÖ **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–∞** —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É Patroni REST API (–ø–æ—Ä—Ç 8008)
- ‚úÖ **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ TCP-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** –∫ PostgreSQL
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** –ø—Ä–∏ —Ñ–µ–π–ª–æ–≤–µ—Ä–µ
- ‚ùå **–ù–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** –ë–î
- ‚ùå **–ù–µ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** –∫ PostgreSQL

#### **PgBouncer - –ø—É–ª–µ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î**
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç PgBouncer:**
- ‚úÖ **–ü—É–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ PostgreSQL
- ‚úÖ **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ PostgreSQL (–º–µ–Ω—å—à–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
- ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π**
- ‚úÖ **–†–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã –ø—É–ª–∏–Ω–≥–∞** (session, transaction, statement)
- ‚ùå **–ù–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫—Ç–æ –ª–∏–¥–µ—Ä** –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

#### **–ü–æ—á–µ–º—É –Ω—É–∂–Ω—ã –û–ë–ê –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞?**

#### **–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ PgBouncer:**
```bash
# 1–° —Å–æ–∑–¥–∞–µ—Ç 200 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (max_connections)
# –ö–∞–∂–¥–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ = –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å PostgreSQL
# –ü—Ä–∏ —Ñ–µ–π–ª–æ–≤–µ—Ä–µ –≤—Å–µ 200 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —Ä–≤—É—Ç—Å—è
# 1–° –Ω–µ —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è
```

#### **–†–µ—à–µ–Ω–∏–µ —Å PgBouncer + HAProxy:**
```bash
# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
1–° –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí HAProxy (5433) ‚Üí PgBouncer (6432) ‚Üí PostgreSQL –ª–∏–¥–µ—Ä (5432)
                    ‚Üë                    ‚Üë                    ‚Üë
             –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏–¥–µ—Ä–∞    –ü—É–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π    –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ë–î
```

#### **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è 1–°:**

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –§–µ–π–ª–æ–≤–µ—Ä –º–∞—Å—Ç–µ—Ä–∞**
```bash
# –ë–µ–∑ PgBouncer:
# - 60 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π 1–° —Ä–≤—É—Ç—Å—è
# - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –æ—à–∏–±–∫–∏
# - –ù—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å 1–°

# –° PgBouncer:
# - PgBouncer –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–æ–≤–æ–º—É –º–∞—Å—Ç–µ—Ä—É
# - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞–º–µ—á–∞—é—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
# - –°–µ—Å—Å–∏–∏ 1–° –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç—É
```

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**
```bash
# –ë–µ–∑ PgBouncer:
# - –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1–° = 1 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ PostgreSQL
# - –ë—ã—Å—Ç—Ä–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è max_connections (200)
# - –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

# –° PgBouncer:
# - 60 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 1–° –∏—Å–ø–æ–ª—å–∑—É—é—Ç 20-30 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ PostgreSQL
# - –≠–∫–æ–Ω–æ–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
# - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

#### **–¢–∏–ø–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è 1–° + Patroni:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   1–° –ö–ª–∏–µ–Ω—Ç—ã ‚îÇ ‚îÄ‚îÄ‚Üí ‚îÇ   HAProxy   ‚îÇ ‚îÄ‚îÄ‚Üí ‚îÇ  PgBouncer  ‚îÇ ‚îÄ‚îÄ‚Üí ‚îÇ  PostgreSQL  ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ   (5433)    ‚îÇ    ‚îÇ   (6432)    ‚îÇ    ‚îÇ   (5432)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                        ‚îÇ              ‚îÇ
                                                        ‚îÇ   Patroni    ‚îÇ
                                                        ‚îÇ   Cluster    ‚îÇ
                                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```



**HAProxy —Å–∞–º –Ω–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ –º–∞—Å—Ç–µ—Ä–∞?** 
- ‚úÖ **–ú–û–ñ–ï–¢** –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å **–Ω–æ–≤—ã–µ** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚ùå **–ù–ï –ú–û–ñ–ï–¢** –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å **—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚ùå **–ù–ï –ú–û–ñ–ï–¢** –¥–µ–ª–∞—Ç—å –ø—É–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**PgBouncer —Ä–µ—à–∞–µ—Ç –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–±–ª–µ–º—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** - –æ–Ω –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–æ–≤–æ–º—É –º–∞—Å—Ç–µ—Ä—É –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## **–í—ã–≤–æ–¥:**
–î–ª—è 1–° —Å Patroni **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã –æ–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞**:
- **HAProxy** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ª–∏–¥–µ—Ä–∞ –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
- **PgBouncer** –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ —Ñ–µ–π–ª–æ–≤–µ—Ä–µ


#### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑:
- **Prometheus** + **Grafana**: Patroni –∏ PostgreSQL –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –º–µ—Ç—Ä–∏–∫–∏.
- **pgAudit**: –¥–ª—è –∞—É–¥–∏—Ç–∞.
- **WAL-G/barman**: –¥–ª—è –±—ç–∫–∞–ø–æ–≤.

## **4. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

### –ò—Ç–æ–≥–∏ —Ä–∞–±–æ—Ç—ã: –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã –≤—Å–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ü–µ–ª–∏:
- ‚úÖ –†–∞–∑–≤–µ—Ä–Ω—É—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä PostgreSQL 17 –Ω–∞ –±–∞–∑–µ Patroni –∏ etcd
- ‚úÖ –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ —Å –Ω—É–ª–µ–≤–æ–π –ø–æ—Ç–µ—Ä–µ–π –ø—Ä–∏ —Å–±–æ—è—Ö
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 1–°:–ó–£–ü —Å —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ MS SQL Server 2007 –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –º–µ—Ö–∞–Ω–∏–∑–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PostgreSQL –¥–ª—è workloads 1–°
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã —Ç–µ—Å—Ç–∞–º–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ–µ –º–∞—Å—Ç–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥

### –í—ã–≤–æ–¥—ã: –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π –∏ —Ä–µ—à–µ–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤—ã–∑–æ–≤—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è:**
1. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** - –ü—Ä–æ–±–ª–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è Patroni —Å etcd API v3 —Ä–µ—à–µ–Ω–∞ —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è 1–°** - –¢—Ä–µ–±–æ–≤–∞–ª–∞—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –ª–æ–∫–∞–ª—å—é ru_RU.UTF-8, —á—Ç–æ –±—ã–ª–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–æ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã initdb –≤ Patroni
3. **–†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** - –°–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å SELinux —Ä–µ—à–µ–Ω—ã –ø–æ—ç—Ç–∞–ø–Ω—ã–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∏–∑ permissive –≤ enforcing —Ä–µ–∂–∏–º —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫
4. **–°–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è** - –ù–∞—Å—Ç—Ä–æ–µ–Ω firewalld —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞

**–¶–µ–Ω–Ω—ã–µ —É—Ä–æ–∫–∏:**
- –í–∞–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å—Ç–µ–∫–∞ –Ω–∞ —Ä–∞–Ω–Ω–∏—Ö —ç—Ç–∞–ø–∞—Ö
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏ –∏–∑–æ–ª—è—Ü–∏–∏ –≤ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤

### –û—Ü–µ–Ω–∫–∞ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞

**–ü—Ä—è–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è:**
- –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ Microsoft SQL Server - ‚âà 1.5-3 –º–ª–Ω —Ä—É–±–ª–µ–π
- –û—Ç–∫–∞–∑ –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã - ‚âà  1.5-3 –º–ª–Ω —Ä—É–±–ª–µ–π

**–ö–æ—Å–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã - —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–µ–≤ –Ω–∞ 70%
- –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å –Ω–∞ 40%
- –°–Ω–∏–∂–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É - –Ω–∞ 35%
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –ü–û (MS SQL 2007)

### –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã

**–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **–í–Ω–µ–¥—Ä–µ–Ω–∏–µ HAProxy + PgBouncer** - –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, —á—Ç–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ 1–° –ø—Ä–∏ —Ñ–µ–π–ª–æ–≤–µ—Ä–µ
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Prometheus + Grafana –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –±—ç–∫–∞–ø–∞** - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ pgBackRest –∏–ª–∏ WAL-G –¥–ª—è Point-in-Time Recovery

**–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:**
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –¥–ª—è –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Ansible/Terraform
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏ (Zabbix ‚Üí Telegram/SMS)

**–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ PostgreSQL
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö –°–£–ë–î
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ Data Lake –Ω–∞ –æ—Å–Ω–æ–≤–µ PostgreSQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π TimescaleDB, Citus

### –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥

–ü—Ä–æ–µ–∫—Ç –¥–æ–∫–∞–∑–∞–ª –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫—É—é —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-—Å–∏—Å—Ç–µ–º —Å –ø—Ä–æ–ø—Ä–∏–µ—Ç–∞—Ä–Ω—ã—Ö –°–£–ë–î –Ω–∞ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è. –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –∫ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –∏ —Å–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ò–¢-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è. –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Å–ª—É–∂–∏—Ç—å —ç—Ç–∞–ª–æ–Ω–æ–º –¥–ª—è –ø–æ–¥–æ–±–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π.
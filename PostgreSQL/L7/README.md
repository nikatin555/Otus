# 7. MVCC, vacuum –∏ autovacuum

# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ autovacuum —Å —É—á–µ—Ç–æ–º –æ—Å–æ–±–µ–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–¶–µ–ª—å:**

- –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç pgbench; <br>
- –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã autovacuum; <br>
- –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É autovacuum.


–û–ø–∏—Å–∞–Ω–∏–µ/–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
–ß–∞—Å—Ç—å 1.
    1. –°–æ–∑–¥–∞—Ç—å –í–ú Ubuntu 24 —Å 2 —è–¥—Ä–∞–º–∏ –∏ 4 –ì–± –û–ó–£ –∏ SSD 10GB
    2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –Ω–µ–≥–æ PostgreSQL 17 —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    3. –°–æ–∑–¥–∞—Ç—å –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤: –≤—ã–ø–æ–ª–Ω–∏—Ç—å pgbench -i postgres
    4. –ó–∞–ø—É—Å—Ç–∏—Ç—å pgbench -c8 -P 6 -T 60 -U postgres postgres
    5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL –∏–∑ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∑–∞–Ω—è—Ç–∏—è —Ñ–∞–π–ª–∞
    6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ
    7. –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –ø–æ—á–µ–º—É?
–ß–∞—Å—Ç—å 2.
    8. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª–µ–º –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º–∏ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º –≤ —Ä–∞–∑–º–µ—Ä–µ 1–º–ª–Ω —Å—Ç—Ä–æ–∫
    9. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π
    10. 5 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ—á–∫–µ –ª—é–±–æ–π —Å–∏–º–≤–æ–ª
    11. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ—á–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø—Ä–∏—Ö–æ–¥–∏–ª –∞–≤—Ç–æ–≤–∞–∫—É—É–º
    12. –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è, –ø—Ä–æ–≤–µ—Ä—è—è, –ø—Ä–∏—à–µ–ª –ª–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º
    13. 5 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ—á–∫–µ –ª—é–±–æ–π —Å–∏–º–≤–æ–ª
    14. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π
    15. –û—Ç–∫–ª—é—á–∏—Ç—å –ê–≤—Ç–æ–≤–∞–∫—É—É–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
    16. 10 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ—á–∫–µ –ª—é–±–æ–π —Å–∏–º–≤–æ–ª
    17. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π
    18. –û–±—ä—è—Å–Ω–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    19. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–≤–∞–∫—É—É–º
    20. –ó–∞–¥–∞–Ω–∏–µ —Å–æ *:–ù–∞–ø–∏—Å–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤ —Ü–∏–∫–ª–µ 10 —Ä–∞–∑ –æ–±–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –≤ –∏—Å–∫–æ–º–æ–π —Ç–∞–±–ª–∏—Ü–µ.–ù–µ –∑–∞–±—ã—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä —à–∞–≥–∞ —Ü–∏–∫–ª–∞.

–†–µ—Ñ–ª–µ–∫—Å–∏—è:

1. –ó–∞—á–µ–º –Ω—É–∂–µ–Ω –≤–∞–∫—É—É–º ?
2. –ù–∞–∑–æ–≤–∏—Ç–µ —Å–ø–æ—Å–æ–±—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ACID ?
3. –ö–∞–∫–∞—è –∏–∑ –∫–æ–º–∞–Ω–¥ insert, delete, update —Å–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è –∏ –ø–æ—á–µ–º—É ?


## 1-4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–∞ –í–ú Ubuntu 24.04 —Å 2 —è–¥—Ä–∞–º–∏, 4 –ì–ë –û–ó–£ –∏ 10 –ì–ë SSD. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PostgreSQL 17 —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
```bash
 cat /etc/os-release | grep VERSION
 psql -V
 lscpu
 free -h
 df -h
```
![alt text](image.png) <br>
![alt text](image-1.png) <br>
![alt text](image-2.png) <br>
![alt text](image-3.png)

–ö–æ–º–∞–Ω–¥–∞ `pgbench -i postgres` –≤—ã–ø–æ–ª–Ω—è–µ—Ç **–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é (initialization) —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PostgreSQL.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞:**
1. –°–æ–∑–¥–∞–µ—Ç 4 —Ç–∞–±–ª–∏—Ü—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ë–î (`postgres` –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ):
   - `pgbench_accounts` (–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
   - `pgbench_branches`
   - `pgbench_history`
   - `pgbench_tellers`

2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∏—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞–µ—Ç 1 –≤–µ—Ç–∫—É (branch), 1 –∫–∞—Å—Å–∏—Ä–∞ (teller) –∏ 100,000 —Å—á–µ—Ç–æ–≤ (accounts)
   - –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö ~16-24MB (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ PostgreSQL)

–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:

1. –ö–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–º–µ—é—â–µ–≥–æ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –ë–î (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ: `postgres`).

2. –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```bash
   sudo -u postgres pgbench -i postgres
 ```

3. –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL —Å –ø–æ–º–æ—â—å—é —É—Ç–∏–ª–∏—Ç—ã pgbench:
 ```bash
    sudo -u postgres pgbench -c8 -P 6 -T 60 postgres
 ```
–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ–º –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å, –∫–∞–∫ PostgreSQL —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π, –∏ –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã:**
1. **`-c8`** (–∫–ª–∏–µ–Ω—Ç—ã)  
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç **8 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π**, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.  
   - –ß–µ–º –±–æ–ª—å—à–µ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–µ–º –≤—ã—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –°–£–ë–î.

2. **`-P 6`** (–ø—Ä–æ–≥—Ä–µ—Å—Å)  
   - –í—ã–≤–æ–¥–∏—Ç **–æ—Ç—á—ë—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∫–∞–∂–¥—ã–µ 6 —Å–µ–∫—É–Ω–¥** –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞.  
  
3. **`-T 60`** (–≤—Ä–µ–º—è)  
   - –¢–µ—Å—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å **60 —Å–µ–∫—É–Ω–¥**.  
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç.

4. **`-u postgres`** (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)  
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `postgres`.

5. **`postgres`** (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)  
   - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∏–º–µ–Ω–µ–º `postgres`.  
   - *–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –µ—ë –Ω—É–∂–Ω–æ –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –º—ã –∏ —Å–¥–µ–ª–∞–ª–∏ (`sudo -u postgres pgbench -i postgres`).*

 –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –≤ —Ü–µ–ª–æ–º?
1. **–ó–∞–ø—É—Å–∫–∞–µ—Ç TPC-B-like —Ç–µ—Å—Ç** (–ø–æ—Ö–æ–∂–∏–π –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π):  
   - –í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π —Å—á—ë—Ç (`pgbench_accounts`).  
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å (`UPDATE`).  
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`INSERT` –≤ `pgbench_history`).  

2. **–ò–∑–º–µ—Ä—è–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - **TPS (Transactions Per Second)** ‚Äî —Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥—É.  
   - **Latency (–∑–∞–¥–µ—Ä–∂–∫–∞)** ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö.  

3. **–í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**:
   - –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–±–ª–∞–≥–æ–¥–∞—Ä—è `-P 6`).  
   - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞.  

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω—é–∞–Ω—Å—ã:**
- **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã**:  
  - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∂–∏–º** (`simple`), –≥–¥–µ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.  
  - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è** (`-M prepared`), —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ç–µ—Å—Ç.  

- **–ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã**:  
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL (`shared_buffers`, `work_mem` –∏ –¥—Ä.).  
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–∏—Å–∫–∞.  
  - –ù–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.  

- **–ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å TPS**:  
  - –ß–µ–º –≤—ã—à–µ TPS, —Ç–µ–º –ª—É—á—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.  
  - –ï—Å–ª–∏ `latency` (–∑–∞–¥–µ—Ä–∂–∫–∞) —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ (`-c`), —ç—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞.  

–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ pgbench:
```
root@ubuntu2404p17:~# sudo -u postgres pgbench -c8 -P 6 -T 60 postgres
pgbench (17.5 (Ubuntu 17.5-1.pgdg24.04+1))
starting vacuum...end.
progress: 6.0 s, 243.4 tps, lat 32.535 ms stddev 21.921, 0 failed
progress: 12.0 s, 241.4 tps, lat 33.066 ms stddev 23.474, 0 failed
progress: 18.0 s, 239.8 tps, lat 33.362 ms stddev 22.657, 0 failed
progress: 24.0 s, 253.8 tps, lat 31.429 ms stddev 22.791, 0 failed
progress: 30.0 s, 248.2 tps, lat 32.200 ms stddev 24.286, 0 failed
progress: 36.0 s, 256.5 tps, lat 31.152 ms stddev 19.116, 0 failed
progress: 42.0 s, 264.3 tps, lat 30.256 ms stddev 21.365, 0 failed
progress: 48.0 s, 252.2 tps, lat 31.642 ms stddev 19.684, 0 failed
progress: 54.0 s, 209.8 tps, lat 38.016 ms stddev 28.348, 0 failed
progress: 60.0 s, 173.2 tps, lat 46.182 ms stddev 30.177, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 8
number of threads: 1
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 14304
number of failed transactions: 0 (0.000%)
latency average = 33.509 ms
latency stddev = 23.629 ms
initial connection time = 34.813 ms
tps = 238.314417 (without initial connection time)
```
–ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, —è —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å—Ç–∏–ª —É—Ç–∏–ª–∏—Ç—É `top` –∏ –≤—ã—è–≤–∏–ª, —á—Ç–æ –û–ó–£ –∏ CPU –±—ã–ª–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–æ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏( –û–ó–£: —Å 470 –¥–æ 480–ú–ë, CPU: —Å 0 –¥–æ 12%).

## 5-6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò–∑–º–µ–Ω–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ postgresql.conf —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–¥–∞–Ω–∏—é.
 ```bash
 nano /etc/postgresql/17/main/postgresql.conf
 ```
 ```
 # Add settings for extensions here

max_connections = 40
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 512MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 500
random_page_cost = 4
effective_io_concurrency = 2
work_mem = 6553kB
min_wal_size = 4GB
max_wal_size = 16GB
```
```bash
#–û–±–Ω–æ–≤–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–º –∫–ª–∞—Å—Ç–µ—Ä:
systemctl daemon-reload
pg_ctlcluster 17 main restart

#–ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å–∫–∞—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
 sudo -u postgres pgbench -c8 -P 6 -T 60 postgres
```
–¢–µ—Å—Ç –ø–æ–∫–∞–∑–∞–ª:
```
   sudo -u postgres pgbench -c8 -P 6 -T 60 postgres
pgbench (17.5 (Ubuntu 17.5-1.pgdg24.04+1))
starting vacuum...end.
progress: 6.0 s, 235.7 tps, lat 33.576 ms stddev 21.614, 0 failed
progress: 12.0 s, 231.3 tps, lat 34.569 ms stddev 22.247, 0 failed
progress: 18.0 s, 196.5 tps, lat 40.672 ms stddev 31.384, 0 failed
progress: 24.0 s, 255.0 tps, lat 31.315 ms stddev 21.723, 0 failed
progress: 30.0 s, 241.6 tps, lat 32.953 ms stddev 23.608, 0 failed
progress: 36.0 s, 219.9 tps, lat 36.442 ms stddev 25.531, 0 failed
progress: 42.0 s, 256.3 tps, lat 31.181 ms stddev 19.159, 0 failed
progress: 48.0 s, 250.7 tps, lat 31.886 ms stddev 20.861, 0 failed
progress: 54.0 s, 254.3 tps, lat 31.381 ms stddev 20.269, 0 failed
progress: 60.0 s, 247.2 tps, lat 32.344 ms stddev 21.148, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 8
number of threads: 1
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 14339
number of failed transactions: 0 (0.000%)
latency average = 33.425 ms
latency stddev = 22.889 ms
initial connection time = 30.829 ms
tps = 238.896570 (without initial connection time)
```
## 7. –ê–Ω–∞–ª–∏–∑ –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ PostgreSQL

–¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞–ª 3–∏ —Ä–∞–∑–∞, –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è –∫–ª–∞—Å—Ç–µ—Ä, —Å–µ—Ä–≤–µ—Ä PsotgreSQL:
1) T–µ—Å—Ç‚Ññ1:tps=238 <br>
2) T–µ—Å—Ç‚Ññ2:tps=248 #–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª —Å–µ—Ä–≤–µ—Ä PsotgreSQL (systemctl restart postgresql) <br>
3) –¢–µ—Å—Ç‚Ññ3:tps=228

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (CPU –Ω–∞ 13%, RAM <500MB) —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Ç–æ, —á—Ç–æ pgbench –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã. –†–∞–∑–±–µ—Ä—ë–º –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏**
 1. –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π –º–∞—Å—à—Ç–∞–± —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `pgbench -i` —Å–æ–∑–¥–∞–µ—Ç –ë–î –≤—Å–µ–≥–æ ~24MB
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –∫—ç—à, –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –¥–∏—Å–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
 2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
- 8 –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è 2 —è–¥–µ—Ä - –º–∞–ª–æ–≤–∞—Ç–æ (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)
- PostgreSQL –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å CPU
 3. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ TPC-B —Ç–µ—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ü—Ä–æ—Å—Ç—ã–µ UPDATE/INSERT –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã –Ω–∞–≥—Ä—É–∂–∞–ª–∏ CPU

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏**

1. –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ç–µ—Å—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
sudo -u postgres psql -c "SELECT count(*) FROM pgbench_accounts"
```
–£ –Ω–∞—Å 100000 —Å—Ç—Ä–æ–∫, –∫–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å (–ø—Ä–∏ `-s 1`):
![alt text](image-6.png)

2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∑–∞–ø—É—Å–∫–∞—é:
```bash
watch -n 1 "ps aux | grep postgres"
```
![alt text](image-7.png)
```bash
vmstat 1
```
![alt text](image-5.png)

CPU (mpstat)
```bash
 mpstat -P ALL 1 # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –ø–æ —è–¥—Ä–∞–º
```
- %idle > 10% - CPU –Ω–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ
- –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏ < 20% - –ø—Ä–æ–±–ª–µ–º–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
- %soft  –≤—ã—Å–æ–∫–∏–π - –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏

![alt text](image-8.png)

–Ω–æ –≤ –≤—ã–≤–æ–¥–µ —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –ø–æ–º–µ—à–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:  watch -n 1 "cat /proc/interrupts | head -n 5"
![alt text](image-10.png)

–î–∏—Å–∫ (iostat)
![alt text](image-9.png)

–î–∞–∂–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–æ–µ–≥–æ –∂–µ–ª–µ–∑–∞ —É–ª—É—á—à–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–µ –¥–∞–ª–æ:

–ò–∑–º–µ–Ω–∏–ª –≤ `postgresql.conf`:
```ini
max_connections = 100 #–±—ã–ª–æ 40
random_page_cost = 1.1 #–±—ã–ª–æ 4
effective_io_concurrency = 300 #–±—ã–ª–æ 2
work_mem = 32MB
```
```
tps = 239
```
–ù–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∏–∑–∫–æ–π - –≤–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—è—é, —É –º–µ–Ω—è VirtualBox
–í–µ—Ä—Å–∏—è 7.1.8 r168469 (Qt6.5.3). ¬´–í–∫–ª—é—á–∏—Ç—å PAE/NX¬ª - –≤–∫–ª—é—á–∞—é, —Ç.–∫. –¥–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
PAE/NX –≤ VirtualBox ‚Äî —ç—Ç–æ –æ–ø—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤–µ –≤–∞–∂–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:
1. PAE (Physical Address Extension)
    –ü–æ–∑–≤–æ–ª—è–µ—Ç 32-–±–∏—Ç–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –±–æ–ª–µ–µ —á–µ–º 4 –ì–ë –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –¥–æ 64 –ì–ë).
    –ù—É–∂–Ω–∞, –µ—Å–ª–∏ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ 32-–±–∏—Ç–Ω—É—é –≥–æ—Å—Ç–µ–≤—É—é –û–° (–Ω–∞–ø—Ä–∏–º–µ—Ä, 32-–±–∏—Ç–Ω—ã–π Linux –∏–ª–∏ Windows) –∏ —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –µ–π –±–æ–ª—å—à–µ 4 –ì–ë RAM.
    –î–ª—è 64-–±–∏—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º PAE –æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –±–æ–ª—å—à–∏–µ –æ–±—ä—ë–º—ã –ø–∞–º—è—Ç–∏.
2. NX (No eXecute) Bit
    –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Å—Ç–µ–∫–µ –∏–ª–∏ –∫—É—á–µ).
    –ü–æ–º–æ–≥–∞–µ—Ç –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞—Ç–∞–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞).
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –û–° (Windows DEP, Linux NX/XD).
![alt text](image-11.png)

–ü—Ä–æ–≤–µ—Ä—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –Ω–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
```
 sudo -u postgres pgbench -c 8 -P 6 -T 60 postgres
pgbench (17.5 (Ubuntu 17.5-1.pgdg24.04+1))
starting vacuum...end.
progress: 6.0 s, 1251.5 tps, lat 6.350 ms stddev 4.469, 0 failed
progress: 12.0 s, 1206.0 tps, lat 6.630 ms stddev 4.656, 0 failed
progress: 18.0 s, 990.7 tps, lat 8.065 ms stddev 5.631, 0 failed
progress: 24.0 s, 1021.2 tps, lat 7.839 ms stddev 5.188, 0 failed
progress: 30.0 s, 856.7 tps, lat 9.333 ms stddev 6.671, 0 failed
progress: 36.0 s, 834.0 tps, lat 9.585 ms stddev 6.689, 0 failed
progress: 42.0 s, 940.5 tps, lat 8.502 ms stddev 5.808, 0 failed
progress: 48.0 s, 934.9 tps, lat 8.559 ms stddev 5.699, 0 failed
progress: 54.0 s, 805.0 tps, lat 9.919 ms stddev 6.913, 0 failed
progress: 60.0 s, 769.7 tps, lat 10.400 ms stddev 7.005, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 8
number of threads: 1
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 57668
number of failed transactions: 0 (0.000%)
latency average = 8.317 ms
latency stddev = 5.950 ms
initial connection time = 31.340 ms
tps = 961.294591 (without initial connection time)
```
–° default  `postgresql.conf`: tps = 1029.803466

–¢–µ–ø–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –Ω–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á—É—Ç—å –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã –≤ –¥–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ, —á–µ–º –ø–æ default.

–í–∫–ª—é—á—É –¥–ª—è –º–æ–µ–π VM –∏ 2–π –ø–∞—Ä–∞–º–µ—Ç—Ä Nested VT-X/AMD-V:
```
VBoxManage modifyvm P7.Ubuntu --nested-hw-virt on
```
¬´–í–∫–ª—é—á–∏—Ç—å Nested VT-x/AMD-V¬ª –≤ VirtualBox ‚Äî —ç—Ç–æ –æ–ø—Ü–∏—è, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (–í–ú) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ø–ø–∞—Ä–∞—Ç–Ω—É—é –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö–æ—Å—Ç–µ, –Ω–æ –∏ –≤–Ω—É—Ç—Ä–∏ —Å–∞–º–æ–π –≥–æ—Å—Ç–µ–≤–æ–π –û–°. 
–î–ª—è –Ω–∞—à–µ–π VM —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
![alt text](image-12.png)
—Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏`postgresql.conf`: tps = 1070.397884
–° default  `postgresql.conf`: tps = 1104.377960

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Ö–æ—Å—Ç–µ –¥–ª—è VM  tps –≤—ã—Ä–æ—Å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. 

–ü–æ—Å–º–æ—Ç—Ä–∏–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã `sudo iostat -x 1` - –≤—ã–≤–æ–¥–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–æ–≤ –∏ CPU —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É:

![alt text](image-13.png)

–í —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –≤–∏–¥–Ω–æ, —á—Ç–æ `%iowait` –¥–æ—Ö–æ–¥–∏—Ç –¥–æ 13% –≤—Ä–µ–º–µ–Ω–∏, –∫–æ–≥–¥–∞ CPU –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–ª –∏–∑-–∑–∞ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ (–¥–∏—Å–∫). –ù–æ –ø—Ä–∏—ç—Ç–æ–º %util ‚Äì –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∏—Å–∫–∞ –Ω–µ –ø—Ä–∏–≤—ã—à–∞–µ—Ç 45%. –í –Ω–∞—à–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–∞—é—Ç –Ω–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ 100% –≤—Å–µ –∏–º–µ—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã, —á—Ç–æ –æ—á–µ–Ω—å –ª–æ–≥–∏—á–Ω–æ.

–ú–µ–Ω—è—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `postgresql.conf`, –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª—É—á—à—É—é —Å—Ç–æ—Ä–æ–Ω—É —è –Ω–µ –∑–∞–º–µ—Ç–∏–ª :
```ini
max_connections = 100
shared_buffers = 768MB
effective_cache_size = 2GB
work_mem = 8MB
maintenance_work_mem = 256MB
random_page_cost = 1.1  # –¥–ª—è SSD, –¥–ª—è HDD –æ—Å—Ç–∞–≤–∏—Ç—å 4
effective_io_concurrency = 200  # –¥–ª—è SSD/NVMe
wal_buffers = -1  # –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
checkpoint_completion_target = 0.9
min_wal_size = 1GB
max_wal_size = 4GB
```
```bash
systemctl daemon-reload
pg_ctlcluster 17 main restart
 systemctl restart postgresql
```
```
tps = 991.516424
````
## 8-9. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
–°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª–µ–º –∏ –∑–∞–ø–æ–ª–Ω–∏–º —Å–ª—É—á–∞–π–Ω—ã–º–∏ –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º –≤ —Ä–∞–∑–º–µ—Ä–µ 1–º–ª–Ω —Å—Ç—Ä–æ–∫:
```sql
CREATE TABLE test_text (id serial, content text);
INSERT INTO test_text (content) 
SELECT md5(random()::text) FROM generate_series(1, 1000000);
```
–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: 65 MB <br>

–ò–ª–∏ —Ç–∞–∫–∂–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:
```sql
#–†–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Ç–∞–±–ª–∏—Ü—ã (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ TOAST):
postgres=# SELECT pg_size_pretty(pg_relation_size('test_text'));
 pg_size_pretty
----------------
 65 MB
(1 row)

# –ü–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã —Å–æ –≤—Å–µ–º–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏:
postgres=#  SELECT pg_size_pretty(pg_total_relation_size('test_text'))
postgres-# ;
 pg_size_pretty
----------------
 65 MB
(1 row)
```
## 10-11. –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞
–ß—Ç–æ–±—ã 5 —Ä–∞–∑ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `test_text`, –¥–æ–±–∞–≤–ª—è—è –∫ –ø–æ–ª—é `text_data` —Å–∏–º–≤–æ–ª –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤. –í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤:

üîÑ **–°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –±–ª–æ–∫–∞ PL/pgSQL**
```sql
DO $$
BEGIN
  FOR i IN 1..5 LOOP
    UPDATE test_text SET text_data = text_data || 'x';  -- –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª 'x'
    RAISE NOTICE '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ % –∑–∞–≤–µ—Ä—à–µ–Ω–æ', i;  -- –≤—ã–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏
  END LOOP;
END $$;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ).
- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `RAISE NOTICE`.

üîÑ **–°–ø–æ—Å–æ–± 2: 5 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤**
```sql
-- –ò—Ç–µ—Ä–∞—Ü–∏—è 1
UPDATE test_text SET text_data = text_data || 'a';

-- –ò—Ç–µ—Ä–∞—Ü–∏—è 2
UPDATE test_text SET text_data = text_data || 'b';

-- –ò—Ç–µ—Ä–∞—Ü–∏—è 3
UPDATE test_text SET text_data = text_data || 'c';

-- –ò—Ç–µ—Ä–∞—Ü–∏—è 4
UPDATE test_text SET text_data = text_data || 'd';

-- –ò—Ç–µ—Ä–∞—Ü–∏—è 25
UPDATE test_text SET text_data = text_data || 'e';
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∏–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.

---

üîÑ **–°–ø–æ—Å–æ–± 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, Bash)**
```bash
for i in {1..5}; do
  psql -U postgres -d your_db -c "UPDATE test_text SET text_data = text_data || '$i';"
done
```

üîÑ **–°–ø–æ—Å–æ–± 4: –ß–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)**
```sql
CREATE OR REPLACE FUNCTION update_multiple_times(n INTEGER) RETURNS VOID AS $$
BEGIN
  FOR i IN 1..n LOOP
    UPDATE test_text SET text_data = text_data || 'x';
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- –í—ã–∑–æ–≤
SELECT update_multiple_times(5);
```
 **–í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã**
1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –ö–∞–∂–¥—ã–π `UPDATE` –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏. –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏–∑ 1 –º–ª–Ω —Å—Ç—Ä–æ–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ.
  
2. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:
   - –î–æ–ª–≥–∏–π `UPDATE` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É. –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `LIMIT` —Å `OFFSET`.

3. **WAL-–Ω–∞–≥—Ä—É–∑–∫–∞**:
   - –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ WAL. –î–ª—è —Ç–µ—Å—Ç–∞ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –Ω–∞–¥–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É.

4. **–ê–≤—Ç–æ–≤–∞–∫—É—É–º**:
   - –ü–æ—Å–ª–µ 5 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ—è–≤–∏—Ç—Å—è –º–Ω–æ–≥–æ "–º–µ—Ä—Ç–≤—ã—Ö" —Å—Ç—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ —Ç–∞–∫:
     ```sql
     SELECT n_dead_tup FROM pg_stat_user_tables WHERE relname = 'test_text';
     ```

üìå **–ü—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º (–¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü)**
```sql
DO $$
DECLARE
  total_rows BIGINT;
  batch_size INT := 100000;
BEGIN
  SELECT COUNT(*) INTO total_rows FROM test_text;
  
  FOR i IN 1..5 LOOP
    RAISE NOTICE '–ò—Ç–µ—Ä–∞—Ü–∏—è % –∏–∑ 5', i;
    
    FOR j IN 0..(total_rows/batch_size) LOOP
      UPDATE test_text 
      SET text_data = text_data || 'x'
      WHERE id BETWEEN (j*batch_size) AND ((j+1)*batch_size - 1);
      
      COMMIT;  -- –§–∏–∫—Å–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –ø–∞—Ä—Ç–∏—é
      RAISE NOTICE '–ü—Ä–æ–≥—Ä–µ—Å—Å: %%%', (j*100)/(total_rows/batch_size);
    END LOOP;
  END LOOP;
END $$;
```

üî• **–°–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞**
```sql
DO $$
DECLARE
  batch_size INT := 50000;  -- 50k —Å—Ç—Ä–æ–∫ –∑–∞ —Ä–∞–∑
  max_duration INTERVAL := '5 min';  -- –ú–∞–∫—Å. –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
  start_time TIMESTAMP := clock_timestamp();
BEGIN
  FOR i IN 1..5 LOOP
    FOR j IN 0..(SELECT COUNT(*) FROM test_text)/batch_size LOOP
      EXIT WHEN (clock_timestamp() - start_time) > max_duration;  -- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π
      
      UPDATE test_text 
      SET text_data = text_data || 'x'
      WHERE id IN (
        SELECT id FROM test_text
        ORDER BY id
        LIMIT batch_size OFFSET (j*batch_size)
      );
      
      COMMIT;
      RAISE NOTICE '–ò—Ç–µ—Ä–∞—Ü–∏—è %, –ø–∞–∫–µ—Ç %', i, j;
    END LOOP;
  END LOOP;
END $$;
```

**–ü–æ—á–µ–º—É –ª—É—á—à–µ:**  
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `LIMIT/OFFSET` –≤–º–µ—Å—Ç–æ `BETWEEN` (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π).  
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (`max_duration`).  
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–∞–±–ª–∏—Ü —Å —á–∞—Å—Ç—ã–º–∏ `INSERT/DELETE`. 


 üìä **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**

| **–ö—Ä–∏—Ç–µ—Ä–∏–π**               | **–°–ø–æ—Å–æ–± 1** (`DO` –±–ª–æ–∫) | **–°–ø–æ—Å–æ–± 3** (5 –∑–∞–ø—Ä–æ—Å–æ–≤) | **–°–ø–æ—Å–æ–± 4** (–§—É–Ω–∫—Ü–∏—è) | **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä** (–ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) |
|----------------------------|--------------------------|---------------------------|------------------------|----------------------------------------|
| **–£–¥–æ–±—Å—Ç–≤–æ**               | ‚úÖ –ó–∞–ø—É—Å–∫ 1 —Ä–∞–∑          | ‚ùå –†—É—á–Ω–æ–π –≤–≤–æ–¥ 5 —Ä–∞–∑       | ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ    | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ         |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**     | ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è 1M+ —Å—Ç—Ä–æ–∫ | ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ CLI | ‚ùå –ö–∞–∫ –°–ø–æ—Å–æ–± 1         | ‚úÖ –õ—É—á—à–∞—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü           |
| **–ö–æ–Ω—Ç—Ä–æ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**    | ‚ùå –í—Å—è —Ä–∞–±–æ—Ç–∞ –≤ 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | ‚úÖ –ö–∞–∂–¥—ã–π `UPDATE` –æ—Ç–¥–µ–ª—å–Ω–æ | ‚ùå –ö–∞–∫ –°–ø–æ—Å–æ–± 1         | ‚úÖ –ü–∞–∫–µ—Ç—ã —Å `COMMIT`                   |
| **–ì–∏–±–∫–æ—Å—Ç—å**               | ‚ö†Ô∏è –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –∏—Ç–µ—Ä–∞—Ü–∏–π | ‚ùå –ñ—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ    | ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã | ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞            |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**            | ‚úÖ `RAISE NOTICE`        | ‚ùå –ù–µ—Ç                     | ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å       | ‚úÖ –ü–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å                  |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** | ‚ùå –†–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫     | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –¥–ª—è –º–∞–ª—ã—Ö —Ç–∞–±–ª–∏—Ü | ‚ö†Ô∏è –û—Å—Ç–æ—Ä–æ–∂–Ω–æ           | ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ                          |

 üéØ **–ö–æ–≥–¥–∞ –∫–∞–∫–æ–π —Å–ø–æ—Å–æ–± –≤—ã–±—Ä–∞—Ç—å?**
**1. –°–ø–æ—Å–æ–± 1 (`DO` –±–ª–æ–∫) ‚Äî –õ—É—á—à–µ –¥–ª—è:**
- **–¢–µ—Å—Ç–æ–≤—ã—Ö/—É—á–µ–±–Ω—ã—Ö –∑–∞–¥–∞—á** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ —Å `pgbench`).
- **–ú–∞–ª—ã—Ö —Ç–∞–±–ª–∏—Ü** (–¥–æ 100 —Ç—ã—Å. —Å—Ç—Ä–æ–∫).
- **–ü—Ä–æ—Å—Ç–æ—Ç—ã** ‚Äî –Ω–µ –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

**–ü—Ä–∏–º–µ—Ä:**  
```sql
DO $$ BEGIN
  FOR i IN 1..5 LOOP
    UPDATE test_text SET text_data = text_data || 'x';
  END LOOP;
END $$;
```

**2. –°–ø–æ—Å–æ–± 3 (5 –∑–∞–ø—Ä–æ—Å–æ–≤) ‚Äî –õ—É—á—à–µ –¥–ª—è:**
- **–†–∞–∑–æ–≤—ã—Ö —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**, –≥–¥–µ –Ω—É–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥.
- **–û—Ç–ª–∞–¥–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `UPDATE`).

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**  
- –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
- –†–∏—Å–∫ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –∏—Ç–µ—Ä–∞—Ü–∏—é).

### **3. –°–ø–æ—Å–æ–± 4 (–§—É–Ω–∫—Ü–∏—è) ‚Äî –õ—É—á—à–µ –¥–ª—è:**
- **–ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ).
- **–°–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏).

**–ü—Ä–∏–º–µ—Ä:**  
```sql
CREATE OR REPLACE FUNCTION update_n_times(n INT) RETURNS VOID AS $$
BEGIN
  FOR i IN 1..n LOOP
    UPDATE test_text SET text_data = text_data || 'x';
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- –í—ã–∑–æ–≤:
SELECT update_n_times(5);
```
**4. –°–ø–æ—Å–æ–± —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º (–ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ‚Äî –õ—É—á—à–µ –¥–ª—è:**
- **–ë–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü** (–æ—Ç 1 –º–ª–Ω —Å—Ç—Ä–æ–∫).
- **–ü—Ä–æ–¥–∞–∫—à–µ–Ω–∞**, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–æ–ª–≥–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.
- **–ö–æ–Ω—Ç—Ä–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã** (WAL, CPU, I/O).

**–ü—Ä–∏–º–µ—Ä:**  
```sql
DO $$
DECLARE
  batch_size INT := 100000;  -- –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞
  total_rows BIGINT;
BEGIN
  SELECT COUNT(*) INTO total_rows FROM test_text;
  
  FOR i IN 1..5 LOOP
    FOR j IN 0..(total_rows/batch_size) LOOP
      UPDATE test_text 
      SET text_data = text_data || 'x'
      WHERE id BETWEEN (j*batch_size) AND ((j+1)*batch_size - 1);
      
      COMMIT;  -- –§–∏–∫—Å–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞
      RAISE NOTICE '–ò—Ç–µ—Ä–∞—Ü–∏—è %, –ø—Ä–æ–≥—Ä–µ—Å—Å: %/%', i, j, (total_rows/batch_size);
    END LOOP;
  END LOOP;
END $$;
```

1. –ü–æ–ø—Ä–æ–±—É–µ–º **–°–ø–æ—Å–æ–± 1**: 
   - –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç—å.  
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–∞–ª—ã—Ö —Ç–∞–±–ª–∏—Ü.

```sql
postgres=# DO $$
BEGIN
  FOR i IN 1..5 LOOP
    UPDATE test_text SET content = content || 'x';  -- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Å—Ç–æ–ª–±—Ü–∞
    RAISE NOTICE '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ % –∑–∞–≤–µ—Ä—à–µ–Ω–æ', i;
  END LOOP;
END $$;
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 4 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 5 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
DO
```
–ü–æ—Å–ª–µ 5 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è—é:

```sql
SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
```
![alt text](image-16.png)

## 12-14. –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–û–±–Ω–æ–≤–ª—è—é –µ—â–µ —Ä–∞–∑:
```sql
postgres=# DO $$
BEGIN
  FOR i IN 1..5 LOOP
    UPDATE test_text SET content = content || 'x';  -- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Å—Ç–æ–ª–±—Ü–∞
    RAISE NOTICE '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ % –∑–∞–≤–µ—Ä—à–µ–Ω–æ', i;
  END LOOP;
END $$;
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 4 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
NOTICE:  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 5 –∑–∞–≤–µ—Ä—à–µ–Ω–æ
DO
```
–ü–æ—Å–ª–µ 5 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—è—é :
–†–µ–∑—É–ª—å—Ç–∞—Ç: 5–º–ª–Ω.–º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫, –∞–≤—Ç–æ–≤–∞–∫—É—É–º –µ—â–µ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª
```sql
postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |       last_autovacuum
------------+------------------------------
    5000000 | 2025-07-01 17:02:08.22277+00
(1 row)

postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |       last_autovacuum
------------+------------------------------
    5000000 | 2025-07-01 17:02:08.22277+00
(1 row)

postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |       last_autovacuum
------------+------------------------------
    5000000 | 2025-07-01 17:02:08.22277+00
(1 row)

postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |       last_autovacuum
------------+------------------------------
    5000000 | 2025-07-01 17:02:08.22277+00
(1 row)

postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |       last_autovacuum
------------+------------------------------
    5000000 | 2025-07-01 17:02:08.22277+00
(1 row)

postgres=# SELECT n_dead_tup, last_autovacuum FROM pg_stat_user_tables WHERE relname = 'test_text';
 n_dead_tup |        last_autovacuum
------------+-------------------------------
          0 | 2025-07-01 17:04:08.293486+00
(1 row)
```
–ü–æ—Å–ª–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞:
- –ú–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫: 0
- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: 438 MB (—Ä–æ—Å—Ç –∏–∑-–∑–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
```sql
SELECT 
    schemaname AS schema,
    relname AS table_name,
    n_live_tup AS "–ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    n_dead_tup AS "–ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    last_autovacuum AS "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–≤—Ç–æ–≤–∞–∫—É—É–º",
    autovacuum_count AS "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–æ–≤"
FROM 
    pg_stat_user_tables 
WHERE 
    relname = 'test_text';
```
![alt text](image-15.png)

```sql   
\dt+;
                                         List of relations
 Schema |       Name       | Type  |  Owner   | Persistence | Access method |  Size   | Description
--------+------------------+-------+----------+-------------+---------------+---------+-------------
 public | pgbench_accounts | table | postgres | permanent   | heap          | 14 MB   |
 public | pgbench_branches | table | postgres | permanent   | heap          | 264 kB  |
 public | pgbench_history  | table | postgres | permanent   | heap          | 3096 kB |
 public | pgbench_tellers  | table | postgres | permanent   | heap          | 104 kB  |
 public | test_text        | table | postgres | permanent   | heap          | 438 MB  |
(5 rows)

postgres=# SELECT pg_size_pretty(pg_relation_size('test_text'));
 pg_size_pretty
----------------
 438 MB
(1 row)

postgres=# SELECT pg_size_pretty(pg_total_relation_size('test_text'));
 pg_size_pretty
----------------
 438 MB
(1 row)
```
–í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã:

1. –ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ UPDATE –∏–ª–∏ DELETE ‚Äî –æ–Ω–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–µ, –Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–æ –æ—á–∏—Å—Ç–∫–∏.

2. –ê–≤—Ç–æ–≤–∞–∫—É—É–º –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞:

3. –ß–∏—Å–ª–æ –º—ë—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç autovacuum_vacuum_threshold + (autovacuum_vacuum_scale_factor * –æ–±—â–µ–µ_—á–∏—Å–ª–æ_—Å—Ç—Ä–æ–∫).

4. –ß–∞—Å—Ç—ã–µ UPDATE –±–µ–∑ –≤–∞–∫—É—É–º–∞ –ø—Ä–∏–≤–æ–¥—è—Ç –∫:

- –†–æ—Å—Ç—É —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã.

- –°–Ω–∏–∂–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## 15-17. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞

–ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã:
```sql 
SELECT 
    relname,
    reloptions 
FROM 
    pg_class 
WHERE 
    relname = 'test_text';
```

![alt text](image-17.png)

reloptions –ø—É—Å—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

–ü–æ—Å–º–æ—Ç—Ä–∏–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞:

```sql
SHOW autovacuum_vacuum_threshold;
SHOW autovacuum_vacuum_scale_factor;
```
![alt text](image-18.png)

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: vacuum_threshold = 50, scale_factor = 0.2 ‚Äî –∞–≤—Ç–æ–≤–∞–∫—É—É–º —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ 50 + 0.2 * total_rows –º—ë—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö.

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∞–∫—É—É–º –º–æ–∂–Ω–æ (–µ—Å–ª–∏ –º—ë—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ –º–Ω–æ–≥–æ, –∞ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç):
```sql 
VACUUM FULL VERBOSE test_text;
```
=====================================
### 15. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `test_text`:

```sql
ALTER TABLE test_text SET (autovacuum_enabled = off);
```

–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω:
```sql
SELECT relname, reloptions FROM pg_class WHERE relname = 'test_text';
```
–†–µ–∑—É–ª—å—Ç–∞—Ç - –≤—ã–∫–ª.:
```
 relname  |           reloptions            
----------+----------------------------------
 test_text| {autovacuum_enabled=off}
```

### 16. 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (–°–ø–æ—Å–æ–± 1)
```sql
DO $$
BEGIN
  FOR i IN 1..10 LOOP
    UPDATE test_text SET content = content || 'x';  -- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Å—Ç–æ–ª–±—Ü–∞
    RAISE NOTICE '–í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ %/10', i;
  END LOOP;
END $$;
```
```sql
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 1/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 2/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 3/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 4/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 5/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 6/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 7/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 8/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 9/10
NOTICE:  –í—ã–ø–æ–ª–Ω–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 10/10
DO
```

### 17. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
\dt+;
postgres=# SELECT pg_size_pretty(pg_relation_size('test_text'));
 pg_size_pretty
----------------
 879 MB
(1 row)

postgres=# SELECT pg_size_pretty(pg_total_relation_size('test_text'));
 pg_size_pretty
----------------
 879 MB
(1 row)
```
![](image-19.png)

## üîç18. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

1. **–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –±—É–¥–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–µ**, —á–µ–º –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞, —Ç.–∫.:
   - –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫;
   - –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è (—Ç–∞–∫ –∫–∞–∫ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –æ—Ç–∫–ª—é—á–µ–Ω);
   - PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º MVCC (Multiversion Concurrency Control).


2. **–ü—Ä–æ–≤–µ—Ä–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫**:
```sql
SELECT n_dead_tup, last_autovacuum 
FROM pg_stat_user_tables 
WHERE relname = 'test_text';
```
![alt text](image-21.png)
–∏–ª–∏
```sql
SELECT
    schemaname AS schema,
    relname AS table_name,
    n_live_tup AS "–ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    n_dead_tup AS "–ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    last_autovacuum AS "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–≤—Ç–æ–≤–∞–∫—É—É–º",
    autovacuum_count AS "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–æ–≤"
FROM
    pg_stat_user_tables
WHERE
    relname = 'test_text';
```
![alt text](image-20.png)

–ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞ –∏ 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:
- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≤—ã—Ä–æ—Å –¥–æ 880 MB
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫: 10M

3. **–§–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤** –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–∫:
```sql
SELECT pg_relation_filepath('test_text');
```
![alt text](image-22.png)

–ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —á–µ—Ä–µ–∑ OS:
```bash
ls -lh /var/lib/postgresql/17/main/base/5/16692
-rw------- 1 postgres postgres 880M Jul  1 17:49 /var/lib/postgresql/17/main/base/5/16692
```

**–ï—Å–ª–∏ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –¥–æ–ª–≥–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω**: <br>
1. PostgreSQL –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ, –∑–∞–Ω—è—Ç–æ–µ –º–µ—Ä—Ç–≤—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏. –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞. <br>
2. –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞–Ω—É—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ (PostgreSQL –¥–æ–ª–∂–µ–Ω —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –º—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏).<br>
3. –†–∏—Å–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ wraparound (–∫—Ä–∞–π–Ω–µ –æ–ø–∞—Å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è, –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ—Å—Ç–æ—é –ë–î).

## 19. –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–∞

1. –ü–æ—Å–ª–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –Ω–µ –∑–∞–±—É–¥–µ–º –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–≤–∞–∫—É—É–º:
```sql
ALTER TABLE test_text SET (autovacuum_enabled = on);
VACUUM FULL test_text;  -- –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```
–ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω:
```sql
SELECT relname, reloptions FROM pg_class WHERE relname = 'test_text';
```
![alt text](image-24.png)

```sql
SELECT
    schemaname AS schema,
    relname AS table_name,
    n_live_tup AS "–ñ–∏–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    n_dead_tup AS "–ú—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏",
    last_autovacuum AS "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–≤—Ç–æ–≤–∞–∫—É—É–º",
    autovacuum_count AS "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º–æ–≤"
FROM
    pg_stat_user_tables
WHERE
    relname = 'test_text';
```
![alt text](image-23.png)

2. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-—Å—Ä–µ–¥—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–≤–∞–∫—É—É–º –ø–æ–ª–Ω–æ—Å—Ç—å—é - —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:
   - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–º—É –∑–∞–º–µ–¥–ª–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã –ë–î
   - –†–∞–∑–¥—É–≤–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü
   - –í–æ–∑–º–æ–∂–Ω—ã–º –ø—Ä–æ–±–ª–µ–º–∞–º —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º wraparound

## 20.–ó–∞–¥–∞–Ω–∏–µ —Å–æ *: –ù–∞–ø–∏—Å–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤ —Ü–∏–∫–ª–µ 10 —Ä–∞–∑ –æ–±–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –≤ –∏—Å–∫–æ–º–æ–π —Ç–∞–±–ª–∏—Ü–µ. –ù–µ –∑–∞–±—ã—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä —à–∞–≥–∞ —Ü–∏–∫–ª–∞.

```sql
DO $$
BEGIN
  FOR i IN 1..10 LOOP
    RAISE NOTICE '–®–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è %', i;
    UPDATE test_text SET content = content || '#' || i;
  END LOOP;
END $$;
```
![alt text](image-25.png)

–ù–µ–º–Ω–æ–≥–æ —É—Å–ª–æ–∂–Ω–∏–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –≤—ã–≤–µ–¥–µ–º —Å –Ω–æ–º–µ—Ä–æ–º —à–∞–≥–∞ –≤—Ä–µ–º—è, –∑–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫:
```sql
DO $$
DECLARE
  start_time TIMESTAMP;
  end_time TIMESTAMP;
  loop_duration INTERVAL;
  total_rows BIGINT;
BEGIN
  -- –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
  SELECT COUNT(*) INTO total_rows FROM test_text;
  RAISE NOTICE '–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ: %', total_rows;
  
  FOR i IN 1..10 LOOP
    -- –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏
    start_time := clock_timestamp();
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
    UPDATE test_text SET content = content || 'x';
    
    -- –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
    end_time := clock_timestamp();
    loop_duration := end_time - start_time;
    
    -- –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —à–∞–≥–µ
    RAISE NOTICE '–®–∞–≥ % –∏–∑ 10 –≤—ã–ø–æ–ª–Ω–µ–Ω. –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: %, –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: %', 
                 i, loop_duration, total_rows;
  END LOOP;
  
  RAISE NOTICE '–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã.';
END $$;
```
![alt text](image-26.png)

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:

   1. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

        - –í –Ω–∞—á–∞–ª–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ

        - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Ü–∏–∫–ª–∞ –≤—ã–≤–æ–¥–∏—Ç—Å—è:

            - –ù–æ–º–µ—Ä –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–æ—Ç 1 –¥–æ 10)

            - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

            - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫

    2. –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

       - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è clock_timestamp() –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

       - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏

    3. –ì–∏–±–∫–æ—Å—Ç—å:

       - –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π (–∏–∑–º–µ–Ω–∏–≤ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É —Ü–∏–∫–ª–∞)

       - –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª—è–µ–º—ã–π —Å–∏–º–≤–æ–ª (—Å–µ–π—á–∞—Å 'x')

    4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

       - –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

       - –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å COMMIT –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–î–æ–±–∞–≤–∏–º –≤ –∞–Ω–æ–Ω–∏–º–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```sql
DO $$
DECLARE
  global_start_time TIMESTAMP := clock_timestamp();
  step_start_time TIMESTAMP;
  step_duration INTERVAL;
  total_duration INTERVAL;
  total_rows BIGINT;
  initial_size BIGINT;
  final_size BIGINT;
  rows_updated BIGINT := 0;
BEGIN
  -- –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  SELECT COUNT(*) INTO total_rows FROM test_text;
  SELECT pg_total_relation_size('test_text') INTO initial_size;
  
  RAISE NOTICE '–ù–ê–ß–ê–õ–û –ü–†–û–¶–ï–î–£–†–´';
  RAISE NOTICE '-------------------------------------';
  RAISE NOTICE '–ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: %', pg_size_pretty(initial_size);
  RAISE NOTICE '–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ: %', total_rows;
  RAISE NOTICE '-------------------------------------';

  -- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  FOR i IN 1..10 LOOP
    step_start_time := clock_timestamp();
    
    -- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    UPDATE test_text SET content = content || 'x';
    rows_updated := rows_updated + total_rows;
    
    -- –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —à–∞–≥–∞
    step_duration := clock_timestamp() - step_start_time;
    
    RAISE NOTICE '–®–∞–≥ % –∏–∑ 10 –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ %', i, step_duration;
  END LOOP;

  -- –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  total_duration := clock_timestamp() - global_start_time;
  SELECT pg_total_relation_size('test_text') INTO final_size;
  
  RAISE NOTICE '-------------------------------------';
  RAISE NOTICE '–ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê';
  RAISE NOTICE '–û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: %', total_duration;
  RAISE NOTICE '–ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: %', pg_size_pretty(final_size);
  RAISE NOTICE '–ü—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞: %', pg_size_pretty(final_size - initial_size);
  RAISE NOTICE '–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: % (% –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)', 
               rows_updated, (rows_updated/total_rows::float)::numeric(10,2);
  RAISE NOTICE '–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —à–∞–≥: %', 
               (extract(epoch from total_duration)/10)::numeric(10,4) || ' —Å–µ–∫';
  RAISE NOTICE '–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏: % —Å—Ç—Ä–æ–∫/—Å–µ–∫', 
               (rows_updated/extract(epoch from total_duration))::numeric(10,2);
  RAISE NOTICE '-------------------------------------';
END $$;
```
![alt text](image-27.png)

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

1. **–ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏**:
   - –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤
   - –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–∏—Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞
   - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (—Å —É—á–µ—Ç–æ–º 10 –ø—Ä–æ—Ö–æ–¥–æ–≤)
   - –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞
   - –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å—Ç—Ä–æ–∫ –≤ —Å–µ–∫—É–Ω–¥—É)

2. **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö –¥–æ/–ø–æ—Å–ª–µ
   - –¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Å—Ç—Ä–æ–∫ √ó —Ü–∏–∫–ª—ã)

3. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥**:
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏
   - –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã, –º–µ–≥–∞–±–∞–π—Ç—ã)
   - –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

4. **–ì–∏–±–∫–æ—Å—Ç—å**:
   - –õ–µ–≥–∫–æ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ª—é–±–æ–π —Ç–∞–±–ª–∏—Ü—ã
   - –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π
   - –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å


## –†–µ—Ñ–ª–µ–∫—Å–∏—è

1. **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω –≤–∞–∫—É—É–º?**
   - –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∑–∞–Ω—è—Ç–æ–µ –º–µ—Ä—Ç–≤—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "—Ä–∞–∑–¥—É–≤–∞–Ω–∏–µ" (bloat) —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
   - –ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å wraparound (–∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ) —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

2. **–ù–∞–∑–æ–≤–∏—Ç–µ —Å–ø–æ—Å–æ–±—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ACID?**
   - **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:** WAL (Write-Ahead Log) –∏ –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π –∫–æ–º–º–∏—Ç
   - **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (constraints), —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø—Ä–æ–≤–µ—Ä–∫–∏
   - **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** MVCC (Multiversion Concurrency Control)
   - **–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å WAL –Ω–∞ –¥–∏—Å–∫

3. **–ö–∞–∫–∞—è –∏–∑ –∫–æ–º–∞–Ω–¥ insert, delete, update —Å–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è –∏ –ø–æ—á–µ–º—É ?**
–°–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: `UPDATE`
   - –ü—Ä–∏—á–∏–Ω—ã:
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏ (–∏–∑-–∑–∞ MVCC)
     * –î–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã (–≤—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–Ω–¥–µ–∫—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è)
     * –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–æ–ª—å—à–µ —Ä–∞–±–æ—Ç—ã –¥–ª—è –≤–∞–∫—É—É–º–∞
     * –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ (DELETE) + –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (INSERT)
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫ (–º–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏)
     * –î–≤–æ–π–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ WAL (–∑–∞–ø–∏—Å—å —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)
  
   –í–æ—Ç —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥ `INSERT`, `UPDATE` –∏ `DELETE` –≤ PostgreSQL:

üöÄ **–°–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ (–æ—Ç –±—ã—Å—Ç—Ä–æ–π –∫ –º–µ–¥–ª–µ–Ω–Ω–æ–π)** 

1. **`INSERT`** - **–°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π**  
   - –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã  
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö  
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (WAL)

2. **`DELETE`** - **–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å**  
   - –î–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤)  
   - –ü–æ–º–µ—á–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ, –Ω–æ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ —Å—Ä–∞–∑—É  
   - –¢—Ä–µ–±—É–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ WAL –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

3. **`UPDATE`** - **–°–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π**  
   - –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ (`DELETE`) + –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (`INSERT`)  
   - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫ (–º–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏)  
   - –î–≤–æ–π–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ WAL (–∑–∞–ø–∏—Å—å —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)

## üîç –ü–æ—á–µ–º—É `UPDATE` —Å–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π?

1. **–ú–µ—Ö–∞–Ω–∏–∑–º MVCC (Multiversion Concurrency Control)**  
   - –ü—Ä–∏ `UPDATE` PostgreSQL –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–µ—Å—Ç–µ, –∞:
     * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å—Ç—Ä–æ–∫–∏ (–≤—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å)
     * –ü–æ–º–µ—á–∞–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∫–∞–∫ "–º–µ—Ä—Ç–≤—É—é" (—É–¥–∞–ª–µ–Ω–Ω—É—é)
   - –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–æ—Å—Ç—É —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å–æ–≤

2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**  
   ```sql
   UPDATE table SET column = value WHERE condition;
   ```
   - –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ –ø–æ —É—Å–ª–æ–≤–∏—é (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (constraints)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

3. **–í–ª–∏—è–Ω–∏–µ –Ω–∞ WAL**  
   - –ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —Å—Ç–∞—Ä—ã–µ, —Ç–∞–∫ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è  
   - –ë–æ–ª—å—à–∏–π –æ–±—ä–µ–º –∂—É—Ä–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `INSERT`

## üíÄ –ü—Ä–æ–±–ª–µ–º–∞ –º–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ (Dead Tuples)

1. **–ö–∞–∫ –ø–æ—è–≤–ª—è—é—Ç—Å—è:**
   - –ü–æ—Å–ª–µ `UPDATE` - —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–º–µ—Ä—Ç–≤–æ–π"
   - –ü–æ—Å–ª–µ `DELETE` - –≤—Å—è —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–º–µ—Ä—Ç–≤–æ–π"

2. **–ß–µ–º –æ–ø–∞—Å–Ω—ã:**
   - –£–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
   - –ó–∞–º–µ–¥–ª—è—é—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (PostgreSQL –¥–æ–ª–∂–µ–Ω —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –º–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏)
   - –ú–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ "—Ä–∞–∑–¥—É–≤–∞–Ω–∏—é" (bloat) —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å–æ–≤

3. **–ö–∞–∫ –æ—á–∏—â–∞—é—Ç—Å—è:**
   ```sql
   VACUUM table;  -- –ü–æ–º–µ—á–∞–µ—Ç –º–µ—Å—Ç–æ –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω–æ–µ
   VACUUM FULL table;  -- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–π–ª
   ```

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –û–ø–µ—Ä–∞—Ü–∏—è | –°–∫–æ—Ä–æ—Å—Ç—å | –ú–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ | WAL-–Ω–∞–≥—Ä—É–∑–∫–∞ |
|----------|----------|----------------|------------|--------------|
| `INSERT` | ‚ö°Ô∏è –ë—ã—Å—Ç—Ä–µ–µ | –ù–µ—Ç | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ | –ù–∏–∑–∫–∞—è |
| `DELETE` | üèÉ –°—Ä–µ–¥–Ω—è—è | –î–∞ | –ó–∞–ø–∏—Å–∏+–∏–Ω–¥–µ–∫—Å—ã | –°—Ä–µ–¥–Ω—è—è |
| `UPDATE` | üê¢ –ú–µ–¥–ª–µ–Ω–Ω–µ–µ | –î–∞ (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è) | –ó–∞–ø–∏—Å–∏+–∏–Ω–¥–µ–∫—Å—ã | –í—ã—Å–æ–∫–∞—è |

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ `UPDATE`

1. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã:**
   ```sql
   -- –í–º–µ—Å—Ç–æ
   UPDATE table SET col1=1, col2=2 WHERE id=100;
   -- –õ—É—á—à–µ
   UPDATE table SET col1=1 WHERE id=100;  -- –ï—Å–ª–∏ col2 –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
   ```

2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–∫–µ—Ç–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
   ```sql
   UPDATE table SET col=val WHERE id BETWEEN 1 AND 1000;
   ```

3. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ `VACUUM`:**
   ```sql
   VACUUM ANALYZE table;
   ```

4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–≤–∞–∫—É—É–º:**
   ```sql
   ALTER TABLE table SET (
     autovacuum_vacuum_scale_factor = 0.01,
     autovacuum_vacuum_threshold = 1000
   );
   ```

–ü—Ä–∏–º–µ—Ä —Ä–∞–∑–Ω–∏—Ü—ã –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```sql
-- –¢–µ—Å—Ç–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å 1 –º–ª–Ω —Å—Ç—Ä–æ–∫
CREATE TABLE perf_test (id serial, val text);
INSERT INTO perf_test (val) SELECT md5(random()::text) FROM generate_series(1,1000000);

-- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
INSERT: ~0.5 —Å–µ–∫ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ 10k —Å—Ç—Ä–æ–∫)
DELETE: ~1.2 —Å–µ–∫ (—É–¥–∞–ª–µ–Ω–∏–µ 10k —Å—Ç—Ä–æ–∫)
UPDATE: ~2.5 —Å–µ–∫ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ 10k —Å—Ç—Ä–æ–∫)
```